<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Montero Web - Controle de Acertos</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { margin: 0; padding: 0; background: #f5f5f5; }
    .container { max-width: 450px; margin: 10vh auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    h2 { text-align: center; margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: .5rem; }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"], select {
      width: 100%; padding: .6rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px;
    }
    .password-field { position: relative; }
    .toggle-password {
      position: absolute; top: 10px; right: 10px; cursor: pointer;
      font-size: 1rem; color: #555;
    }
    button {
      padding: .6rem 1rem; background-color: #2c7be5;
      color: white; border: none; border-radius: 5px;
      font-size: 1rem; cursor: pointer;
    }
    .error { color: red; text-align: center; margin-top: 1rem; }
    #telaPrincipal { display: none; padding: 1rem; max-width: 1100px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .positivo { color: green; font-weight: bold; }
    .negativo { color: red; font-weight: bold; }
    @media (max-width: 768px) {
      table th:nth-child(1), table td:nth-child(1) { display: none; }
    }
  </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div class="container" id="telaLogin">
  <h2>Montero Web</h2>
  <form id="formLogin" autocomplete="off">
    <label for="usuario">Usu√°rio:</label>
    <input type="text" id="usuario" required autocomplete="off"/>

    <label for="senha">Senha:</label>
    <div class="password-field">
      <input type="password" id="senha" required autocomplete="new-password"/>
      <span class="toggle-password" onclick="toggleSenha()">üëÅÔ∏è</span>
    </div>

    <button type="submit">Entrar</button>
    <div class="error" id="erroLogin"></div>
  </form>
</div>

<!-- TELA PRINCIPAL COME√áA NA PARTE 2 -->

<div id="telaPrincipal">
  <!-- Bot√£o de logout -->
  <div style="text-align:right; margin-bottom:10px;">
    <button onclick="logout()">Sair</button>
  </div>

  <h2 style="text-align:center">Controle de Acertos</h2>

  <!-- Bloco de cadastro -->
  <div style="display:flex; flex-wrap:wrap; gap:1rem;">
    <input type="date" id="data" style="flex:1" />
    <input type="text" id="motorista" placeholder="Motorista" style="flex:2" />
    <input type="text" id="caminhao" placeholder="Caminh√£o" style="flex:2" />
    <input type="number" id="frete" placeholder="Frete (R$)" style="flex:1" />
    <input type="number" id="comissao" placeholder="Comiss√£o (R$)" style="flex:1" />
    <select id="formaPagamento" style="flex:1">
      <option>Dinheiro</option>
      <option>PIX</option>
      <option>Transfer√™ncia</option>
    </select>
    <input type="text" id="observacao" placeholder="Observa√ß√£o" style="flex:3" />
  </div>

  <!-- Continua√ß√£o na Parte 3: Despesas -->
  <!-- Cadastro de Despesas -->
  <h3 style="margin-top:2rem;">Despesas da Viagem</h3>
  <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap:wrap;">
    <input type="text" id="descDespesa" placeholder="Descri√ß√£o da despesa" style="flex: 2;">
    <input type="number" id="valorDespesa" placeholder="Valor (R$)" style="flex: 1;">
    <button onclick="adicionarDespesa()">Adicionar</button>
  </div>

  <!-- Lista de despesas -->
  <ul id="listaDespesas" style="list-style: none; padding-left: 0;"></ul>

  <!-- Resultado da sobra -->
  <div style="margin-top: 1.5rem;">
    <strong>Sobra: </strong>
    <span id="sobra" style="font-size: 1.2rem;">R$ 0,00</span>
  </div>

  <!-- Bot√µes de a√ß√£o -->
  <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <button onclick="salvarAcerto()">Salvar Acerto</button>
    <button onclick="limparCampos()">Limpar Campos</button>
  </div>
  <hr style="margin:2rem 0;">

  <h3>Acertos Salvos</h3>

  <!-- Filtros -->
  <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
    <input type="date" id="filtroDataInicio" style="flex:1">
    <input type="date" id="filtroDataFim" style="flex:1">
    <input type="text" id="filtroMotorista" placeholder="Filtrar por motorista" style="flex:2">
    <button onclick="carregarAcertos()">Filtrar</button>
  </div>

  <!-- Tabela de acertos -->
  <table border="1" width="100%" style="border-collapse:collapse; text-align:left;">
    <thead style="background:#f0f0f0;">
      <tr>
        <th>Data</th>
        <th>Motorista</th>
        <th>Caminh√£o</th>
        <th>Frete</th>
        <th>Comiss√£o</th>
        <th>Despesas</th>
        <th>Sobra</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaAcertos"></tbody>
  </table>
<script>
  // Refer√™ncia para a cole√ß√£o "acertos" no Firebase
  const acertosRef = collection(db, "acertos");

  async function carregarAcertos() {
    const tabela = document.getElementById("tabelaAcertos");
    tabela.innerHTML = "";

    const filtroInicio = document.getElementById("filtroDataInicio").value;
    const filtroFim = document.getElementById("filtroDataFim").value;
    const filtroMotorista = document.getElementById("filtroMotorista").value.trim().toLowerCase();

    const querySnapshot = await getDocs(acertosRef);
    let totalSobra = 0;
    let totalDespesas = 0;

    querySnapshot.forEach((docSnap) => {
      const acerto = docSnap.data();
      const id = docSnap.id;

      // Filtros
      if (filtroInicio && acerto.data < filtroInicio) return;
      if (filtroFim && acerto.data > filtroFim) return;
      if (filtroMotorista && !acerto.motorista.toLowerCase().includes(filtroMotorista)) return;

      const despesasTotal = (acerto.despesas || []).reduce((acc, d) => acc + parseFloat(d.valor), 0);
      const sobra = acerto.frete - acerto.comissao - despesasTotal;

      totalSobra += sobra;
      totalDespesas += despesasTotal;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${acerto.data}</td>
        <td>${acerto.motorista}</td>
        <td>${acerto.caminhao}</td>
        <td>${formatar(acerto.frete)}</td>
        <td>${formatar(acerto.comissao)}</td>
        <td>${formatar(despesasTotal)}</td>
        <td style="color:${sobra < 0 ? 'red' : 'green'}">${formatar(sobra)}</td>
        <td>
          <button onclick="editarAcerto('${id}')">‚úèÔ∏è</button>
          <button onclick="excluirAcerto('${id}')">üóëÔ∏è</button>
          <button onclick='gerarRecibo(${JSON.stringify(acerto)}, true)'>üìÑ Recibo</button>
          <button onclick='gerarRecibo(${JSON.stringify(acerto)}, false)'>üìÑ Sem Assinatura</button>
        </td>
      `;
      tabela.appendChild(tr);
    });

    // Mostra total (opcional)
    const totalRow = document.createElement("tr");
    totalRow.innerHTML = `
      <td colspan="5"><strong>Totais:</strong></td>
      <td><strong>${formatar(totalDespesas)}</strong></td>
      <td><strong>${formatar(totalSobra)}</strong></td>
      <td></td>
    `;
    tabela.appendChild(totalRow);
  }
</script>
<script>
  // Formata valor em R$ brasileiro
  function formatar(valor) {
    return valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }

  // Editar acerto: carrega campos e despesas
  async function editarAcerto(id) {
    const docSnap = await getDoc(doc(db, "acertos", id));
    if (!docSnap.exists()) return;

    const acerto = docSnap.data();
    idAcertoAtual = id;

    document.getElementById("data").value = acerto.data;
    document.getElementById("motorista").value = acerto.motorista;
    document.getElementById("caminhao").value = acerto.caminhao;
    document.getElementById("frete").value = acerto.frete;
    document.getElementById("comissao").value = acerto.comissao;
    document.getElementById("formaPagamento").value = acerto.formaPagamento;
    document.getElementById("observacao").value = acerto.observacao || "";

    despesas = acerto.despesas || [];
    atualizarListaDespesas();
  }

  // Excluir acerto do Firebase
  async function excluirAcerto(id) {
    if (confirm("Deseja realmente excluir este acerto?")) {
      await deleteDoc(doc(db, "acertos", id));
      carregarAcertos();
    }
  }
</script>
<script>
  let despesas = [];

  function adicionarDespesa() {
    const desc = document.getElementById("descDespesa").value.trim();
    const valor = parseFloat(document.getElementById("valorDespesa").value);

    if (!desc || isNaN(valor)) return;

    despesas.push({ descricao: desc, valor });
    atualizarListaDespesas();
    calcularSobra();

    document.getElementById("descDespesa").value = '';
    document.getElementById("valorDespesa").value = '';
  }

  function atualizarListaDespesas() {
    const ul = document.getElementById("listaDespesas");
    ul.innerHTML = '';
    despesas.forEach((d, i) => {
      const li = document.createElement("li");
      li.innerHTML = `${d.descricao}: ${formatar(d.valor)} 
        <button onclick="removerDespesa(${i})" style="margin-left:10px;color:red;">‚úñ</button>`;
      ul.appendChild(li);
    });
  }

  function removerDespesa(index) {
    despesas.splice(index, 1);
    atualizarListaDespesas();
    calcularSobra();
  }

  function calcularSobra() {
    const frete = parseFloat(document.getElementById("frete").value) || 0;
    const comissao = parseFloat(document.getElementById("comissao").value) || 0;
    const totalDespesas = despesas.reduce((acc, d) => acc + d.valor, 0);
    const sobra = frete - comissao - totalDespesas;

    const sobraSpan = document.getElementById("sobra");
    sobraSpan.textContent = formatar(sobra);
    sobraSpan.style.color = sobra < 0 ? "red" : "green";
  }

  document.getElementById("frete").addEventListener("input", calcularSobra);
  document.getElementById("comissao").addEventListener("input", calcularSobra);

  function limparCampos() {
    document.getElementById("data").value = "";
    document.getElementById("motorista").value = "";
    document.getElementById("caminhao").value = "";
    document.getElementById("frete").value = "";
    document.getElementById("comissao").value = "";
    document.getElementById("formaPagamento").selectedIndex = 0;
    document.getElementById("observacao").value = "";
    despesas = [];
    atualizarListaDespesas();
    calcularSobra();
    idAcertoAtual = null;
  }
</script>
<script>
  function gerarRecibo(acerto, comAssinatura = true) {
    const doc = new window.jspdf.jsPDF();
    const empresa = localStorage.getItem("empresa") || "Montero Transportes";
    const margem = 20;
    let y = 20;

    doc.setFontSize(16);
    doc.text(empresa, 105, y, null, null, "center");

    y += 15;
    doc.setFontSize(12);
    doc.text(`Data da Viagem: ${acerto.data}`, margem, y); y += 10;
    doc.text(`Motorista: ${acerto.motorista}`, margem, y); y += 10;
    doc.text(`Caminh√£o: ${acerto.caminhao}`, margem, y); y += 10;
    doc.text(`Forma de Pagamento: ${acerto.formaPagamento}`, margem, y); y += 10;
    doc.text(`Valor Pago (Comiss√£o): ${formatar(acerto.comissao)}`, margem, y); y += 10;
    doc.text(`Observa√ß√£o: ${acerto.observacao || "-"}`, margem, y); y += 10;

    if (comAssinatura) {
      y += 20;
      doc.text("_________________________________________", margem, y); y += 8;
      doc.text("Assinatura do Motorista", margem, y);
      doc.text("_________________________________________", 120, y - 8);
      doc.text("Assinatura do Propriet√°rio", 120, y);
    }

    doc.save(`recibo_${acerto.motorista}.pdf`);
  }
</script>
<script>
  function gerarRelatorioPDF() {
    const doc = new window.jspdf.jsPDF();
    const empresa = localStorage.getItem("empresa") || "Montero Transportes";
    let y = 20;
    const margem = 15;

    doc.setFontSize(16);
    doc.text(`${empresa} - Relat√≥rio de Acertos`, 105, y, null, null, "center");
    y += 15;
    doc.setFontSize(10);

    let totalSobra = 0;
    let totalDespesas = 0;

    acertosFiltrados.forEach((a, i) => {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }

      const sobra = a.frete - a.comissao - (a.despesas?.reduce((acc, d) => acc + d.valor, 0) || 0);
      const totalDespesasAcerto = a.despesas?.reduce((acc, d) => acc + d.valor, 0) || 0;

      totalSobra += sobra;
      totalDespesas += totalDespesasAcerto;

      doc.text(`${i + 1}) Data: ${a.data} - Motorista: ${a.motorista}`, margem, y); y += 6;
      doc.text(`Caminh√£o: ${a.caminhao} | Frete: ${formatar(a.frete)} | Comiss√£o: ${formatar(a.comissao)} | Sobra: ${formatar(sobra)}`, margem, y); y += 6;
      doc.text(`Forma: ${a.formaPagamento} | Observa√ß√£o: ${a.observacao || "-"}`, margem, y); y += 6;

      if (a.despesas && a.despesas.length) {
        doc.text(`Despesas:`, margem, y); y += 6;
        a.despesas.forEach(d => {
          doc.text(` - ${d.descricao}: ${formatar(d.valor)}`, margem + 10, y); y += 6;
        });
      }

      y += 8;
    });

    y += 10;
    doc.setFontSize(12);
    doc.text(`Total de Despesas: ${formatar(totalDespesas)}`, margem, y); y += 8;
    doc.text(`Total de Sobra: ${formatar(totalSobra)}`, margem, y);

    doc.save(`relatorio_acertos.pdf`);
  }
</script>
<script>
  // Mostrar/ocultar senha com √≠cone de olhinho
  function toggleSenha() {
    const senhaInput = document.getElementById("senha");
    senhaInput.type = senhaInput.type === "password" ? "text" : "password";
  }

  // Logout e limpar localStorage
  function logout() {
    localStorage.removeItem("logado");
    document.getElementById("telaPrincipal").style.display = "none";
    document.getElementById("telaLogin").style.display = "block";
  }

  // Salvar nome personalizado da empresa no navegador
  function salvarNomeEmpresa() {
    const nome = prompt("Digite o nome da empresa:");
    if (nome) {
      localStorage.setItem("empresa", nome.trim());
      alert("Nome da empresa atualizado!");
    }
  }

  // Formatar valor em BRL automaticamente
  function formatar(valor) {
    return valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
      minimumFractionDigits: 2,
    });
  }

  // Ajuste responsivo para esconder coluna data em telas pequenas
  function ajustarLayoutMobile() {
    const largura = window.innerWidth;
    const colData = document.querySelectorAll(".colunaData");
    colData.forEach(col => {
      col.style.display = largura < 600 ? "none" : "table-cell";
    });
  }

  window.addEventListener("resize", ajustarLayoutMobile);
  document.addEventListener("DOMContentLoaded", ajustarLayoutMobile);
</script>
</body>
</html>
