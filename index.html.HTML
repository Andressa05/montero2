<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Acertos</title>
    <!-- Tailwind CSS CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF para geração de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin para tabelas em PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilos globais para o corpo do documento */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        /* Estilo para o contêiner principal para centralizar e limitar a largura */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Estilos para as abas de conteúdo (visibilidade) */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Estilo para inputs de moeda, alinhando o texto à direita */
        .currency-input {
            text-align: right;
        }
        /* Estilos para o modal personalizado */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed; /* Fixado na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Rolagem se necessário */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Barra de alerta fixa para boletos vencendo */
        #boleto-alert-fixed {
            position: sticky; /* Permanece visível ao rolar */
            top: 0;
            left: 0;
            width: 100%;
            background-color: #fbd38d; /* Cor de alerta */
            border-bottom: 1px solid #f6ad55;
            color: #9c4221;
            padding: 10px 20px;
            text-align: center;
            font-weight: bold;
            z-index: 500; /* Abaixo do modal, acima do conteúdo */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none; /* Escondido por padrão */
        }
        /* Estilo para entradas pagas (riscado) */
        .paid-entry {
            text-decoration: line-through;
            color: #6b7280; /* Cor cinza para entradas pagas */
            font-style: italic;
        }
        /* Estilo para alertas vermelhos */
        .alert-red {
            background-color: #f87171; /* bg-red-400 */
            color: #7f1d1d; /* text-red-900 */
            border-color: #ef4444; /* border-red-500 */
        }
        /* Estilo para o canvas de assinatura */
        .signature-canvas {
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: crosshair;
            touch-action: none; /* Previne o scroll da página ao desenhar em touch */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Tela de Login -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login</h2>
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Usuário:</label>
                <input type="text" id="username" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="master">
            </div>
            <div class="mb-6 relative">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
                <input type="password" id="password" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" value="123mudar">
                <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 mt-6">
                    <i class="far fa-eye text-gray-500"></i>
                </button>
            </div>
            <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full">Entrar</button>
            <p id="login-error" class="text-red-500 text-xs italic mt-4 text-center hidden">Usuário ou senha inválidos.</p>
        </div>
    </div>

    <!-- Tela Principal da Aplicação -->
    <div id="app-screen" class="hidden flex-1 flex flex-col">
        <header class="bg-blue-600 text-white p-4 shadow-md">
            <!-- Ajustado para flex-wrap e padding responsivo para melhor adaptação em telas pequenas -->
            <div class="container flex flex-wrap justify-between items-center py-2 sm:py-0">
                <h1 class="text-xl font-bold flex items-center mb-2 sm:mb-0">
                    <span id="company-name">Nome da Empresa</span>
                    <button id="edit-company-name-button" class="ml-2 text-blue-200 hover:text-white focus:outline-none">
                        <i class="fas fa-edit text-sm"></i>
                    </button>
                </h1>
                <div class="flex items-center w-full sm:w-auto justify-end">
                    <span id="user-id-display" class="text-sm mr-4"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Alerta fixo para boletos vencendo hoje -->
        <div id="boleto-alert-fixed" role="alert" class="alert-red">
            ALERTA BOLETO VENCENDO HOJE: <span id="boleto-alert-message-fixed"></span>
        </div>

        <main class="flex-1 p-4 container">
            <div class="bg-white rounded-lg shadow-md p-6">
                <!-- Navegação por Abas -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="tab-acertos" class="tab-button py-2 px-4 text-gray-600 font-medium border-b-2 border-transparent hover:border-blue-500 focus:outline-none active-tab text-blue-600">Acertos de Viagem</button>
                    <button id="tab-caixa" class="tab-button py-2 px-4 text-gray-600 font-medium border-b-2 border-transparent hover:border-blue-500 focus:outline-none">Entrada / Saída (Caixa)</button>
                    <button id="tab-cadastro-caminhoes" class="tab-button py-2 px-4 text-gray-600 font-medium border-b-2 border-transparent hover:border-blue-500 focus:outline-none hidden">Cadastro de Caminhões</button>
                </div>

                <!-- Conteúdo da Aba de Acertos de Viagem -->
                <div id="content-acertos" class="tab-content active">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Acertos de Viagem</h2>
                    <form id="acerto-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="acerto-data" class="block text-gray-700 text-sm font-bold mb-2">Data:</label>
                            <input type="date" id="acerto-data" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="motorista" class="block text-gray-700 text-sm font-bold mb-2">Motorista:</label>
                            <input type="text" id="motorista" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nome do motorista">
                        </div>
                        <div>
                            <label for="caminhao-select" class="block text-gray-700 text-sm font-bold mb-2">Caminhão (Placa):</label>
                            <select id="caminhao-select" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Selecione um caminhão</option>
                            </select>
                        </div>
                        <div>
                            <label for="frete" class="block text-gray-700 text-sm font-bold mb-2">Valor do Frete (R$):</label>
                            <input type="text" id="frete" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline currency-input" placeholder="0,00">
                        </div>
                        <div>
                            <label for="comissao" class="block text-gray-700 text-sm font-bold mb-2">Valor da Comissão (R$):</label>
                            <input type="text" id="comissao" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline currency-input" placeholder="0,00">
                        </div>
                        <div>
                            <label for="forma-pagamento" class="block text-gray-700 text-sm font-bold mb-2">Forma de Pagamento:</label>
                            <select id="forma-pagamento" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartao">Cartão</option>
                                <option value="Boleto">Boleto</option>
                                <option value="Pix">Pix</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="observacoes-acerto" class="block text-gray-700 text-sm font-bold mb-2">Observações:</label>
                            <textarea id="observacoes-acerto" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3" placeholder="Alguma observação..."></textarea>
                        </div>

                        <div class="md:col-span-2 mt-4">
                            <h3 class="text-lg font-semibold mb-2 text-gray-800">Despesas da Viagem</h3>
                            <div id="despesas-container">
                                <!-- Campos de despesa serão adicionados dinamicamente aqui -->
                            </div>
                            <button type="button" id="add-despesa-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mt-2 flex items-center">
                                <i class="fas fa-plus mr-2"></i>Adicionar Despesa
                            </button>
                        </div>

                        <div class="md:col-span-2 mt-4">
                            <p class="text-lg font-bold text-gray-800">Sobra: <span id="sobra-valor" class="text-green-600">R$ 0,00</span></p>
                        </div>

                        <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                            <button type="submit" id="save-acerto-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-save mr-2"></i>Salvar Acerto
                            </button>
                            <button type="button" id="clear-acerto-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-eraser mr-2"></i>Limpar Campos
                            </button>
                        </div>
                    </form>

                    <hr class="my-8 border-gray-300">

                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Acertos Salvos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="filter-acerto-data-inicial" class="block text-gray-700 text-sm font-bold mb-2">Data Inicial:</label>
                            <input type="date" id="filter-acerto-data-inicial" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="filter-acerto-data-final" class="block text-gray-700 text-sm font-bold mb-2">Data Final:</label>
                            <input type="date" id="filter-acerto-data-final" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="filter-acerto-motorista" class="block text-gray-700 text-sm font-bold mb-2">Filtrar por Motorista:</label>
                            <input type="text" id="filter-acerto-motorista" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nome do motorista">
                        </div>
                        <div>
                            <label for="filter-acerto-caminhao" class="block text-gray-700 text-sm font-bold mb-2">Filtrar por Caminhão (Placa/Nome):</label>
                            <!-- ALTERADO PARA SELECT -->
                            <select id="filter-acerto-caminhao" class="shadow appearance-none border rounded-lg w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Todos os Caminhões</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mb-4">
                        <button id="filter-acertos-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-filter mr-2"></i>Filtrar
                        </button>
                        <button id="generate-acerto-report-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i>Gerar Relatório PDF
                        </button>
                    </div>

                    <div class="mb-4">
                        <p class="text-md font-bold text-gray-800">Total Frete: <span id="total-frete-acertos" class="text-blue-600">R$ 0,00</span></p>
                        <p class="text-md font-bold text-gray-800">Total Comissão: <span id="total-comissao" class="text-blue-600">R$ 0,00</span></p>
                        <p class="text-md font-bold text-gray-800">Total Despesas: <span id="total-despesas-acertos" class="text-red-600">R$ 0,00</span></p>
                        <p class="text-md font-bold text-gray-800">Total Sobra: <span id="total-sobra" class="text-green-600">R$ 0,00</span></p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Motorista</th>
                                    <th class="py-3 px-6 text-left">Caminhão</th>
                                    <th class="py-3 px-6 text-left">Frete</th>
                                    <th class="py-3 px-6 text-left">Comissão</th>
                                    <th class="py-3 px-6 text-left">Sobra</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="acertos-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Acertos serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Conteúdo da Aba de Entrada / Saída (Caixa) -->
                <div id="content-caixa" class="tab-content">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Entrada / Saída (Caixa)</h2>

                    <form id="caixa-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="caixa-tipo" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                            <select id="caixa-tipo" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="entrada">Entrada</option>
                                <option value="saida" selected>Saída</option> <!-- Default to Saída -->
                            </select>
                        </div>
                        <div>
                            <label for="caixa-valor" class="block text-gray-700 text-sm font-bold mb-2">Valor (R$):</label>
                            <input type="text" id="caixa-valor" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline currency-input" placeholder="0,00">
                        </div>
                        <div>
                            <label for="caixa-categoria" class="block text-gray-700 text-sm font-bold mb-2">Categoria:</label>
                            <input type="text" id="caixa-categoria" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ex: Combustível, Salário">
                        </div>
                        <div>
                            <label for="caixa-data" class="block text-gray-700 text-sm font-bold mb-2">Data:</label>
                            <input type="date" id="caixa-data" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1 md:col-span-2 flex items-center">
                            <input type="checkbox" id="caixa-is-boleto" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="caixa-is-boleto" class="text-gray-700 text-sm font-bold">É Boleto?</label>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex items-center">
                            <input type="checkbox" id="caixa-is-cheque" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="caixa-is-cheque" class="text-gray-700 text-sm font-bold">É Cheque?</label>
                        </div>
                        <div id="vencimento-field" class="hidden">
                            <label for="caixa-dias-vencimento" class="block text-gray-700 text-sm font-bold mb-2">Dias para Vencimento (Boleto):</label>
                            <input type="number" id="caixa-dias-vencimento" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0">
                        </div>
                        <div id="apresentacao-cheque-field" class="hidden">
                            <label for="caixa-dias-apresentacao-cheque" class="block text-gray-700 text-sm font-bold mb-2">Dias para Apresentação (Cheque):</label>
                            <input type="number" id="caixa-dias-apresentacao-cheque" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="caixa-num-parcelas" class="block text-gray-700 text-sm font-bold mb-2">Número de Parcelas:</label>
                            <input type="number" id="caixa-num-parcelas" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="1" min="1">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="caixa-intervalo-parcelas" class="block text-gray-700 text-sm font-bold mb-2">Intervalo entre Parcelas (ex: "30 dias", "1 mês"):</label>
                            <input type="text" id="caixa-intervalo-parcelas" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Deixe em branco para mensal">
                        </div>
                        <div class="md:col-span-2">
                            <label for="caixa-descricao" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                            <textarea id="caixa-descricao" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="2" placeholder="Descrição do lançamento"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="caixa-observacoes" class="block text-gray-700 text-sm font-bold mb-2">Observações:</label>
                            <textarea id="caixa-observacoes" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="2" placeholder="Observações adicionais"></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                            <button type="submit" id="save-caixa-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-save mr-2"></i>Salvar Lançamento
                            </button>
                            <button type="button" id="clear-caixa-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-eraser mr-2"></i>Limpar Campos
                            </button>
                        </div>
                    </form>

                    <hr class="my-8 border-gray-300">

                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Lançamentos do Caixa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="filter-caixa-tipo" class="block text-gray-700 text-sm font-bold mb-2">Filtrar por Tipo:</label>
                            <select id="filter-caixa-tipo" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="ambos">Ambos</option>
                                <option value="entrada">Entrada</option>
                                <option value="saida">Saída</option>
                                <option value="boletos-vencendo">Boletos Vencendo Hoje</option>
                                <option value="somente-boleto">Somente Boleto</option>
                                <option value="somente-cheque">Somente Cheque</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-caixa-data-inicial" class="block text-gray-700 text-sm font-bold mb-2">Data Inicial:</label>
                            <input type="date" id="filter-caixa-data-inicial" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="filter-caixa-data-final" class="block text-gray-700 text-sm font-bold mb-2">Data Final:</label>
                            <input type="date" id="filter-caixa-data-final" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mb-4">
                        <button id="filter-caixa-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-filter mr-2"></i>Filtrar
                        </button>
                        <button id="generate-caixa-report-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i>Gerar Relatório PDF
                        </button>
                    </div>

                    <div class="mb-4">
                        <p class="text-md font-bold text-gray-800">Total Entradas: <span id="total-entradas" class="text-green-600">R$ 0,00</span></p>
                        <p class="text-md font-bold text-gray-800">Total Saídas: <span id="total-saidas" class="text-blue-600">R$ 0,00</span></p>
                        <p class="text-lg font-bold text-gray-800">Saldo Atual: <span id="total-saldo" class="text-red-600">R$ 0,00</span></p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Tipo</th>
                                    <th class="py-3 px-6 text-left">Valor</th>
                                    <th class="py-3 px-6 text-left">Categoria</th>
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Vencimento / Apresentação</th>
                                    <th class="py-3 px-6 text-left">Descrição</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="caixa-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Caixa entries will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cadastro de Caminhões Tab Content -->
                <div id="content-cadastro-caminhoes" class="tab-content">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Cadastro de Caminhões</h2>
                    <form id="truck-registration-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="truck-name" class="block text-gray-700 text-sm font-bold mb-2">Nome do Caminhão:</label>
                            <input type="text" id="truck-name" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nome ou modelo do caminhão">
                        </div>
                        <div>
                            <label for="truck-plate" class="block text-gray-700 text-sm font-bold mb-2">Placa do Caminhão:</label>
                            <input type="text" id="truck-plate" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ABC1234 ou ABC1D23" maxlength="7" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                        </div>
                        <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                            <button type="submit" id="save-truck-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-truck-moving mr-2"></i>Cadastrar Caminhão
                            </button>
                            <button type="button" id="clear-truck-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-eraser mr-2"></i>Limpar Campos
                            </button>
                        </div>
                    </form>

                    <hr class="my-8 border-gray-300">

                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Caminhões Cadastrados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Nome do Caminhão</th>
                                    <th class="py-3 px-6 text-left">Placa do Caminhão</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="trucks-table-body" class="text-gray-600 text-sm font-light">
                                <!-- Caminhões serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Alert/Confirmation Modal -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg mb-4"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-confirm-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hidden">Confirmar</button>
                <button id="modal-cancel-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hidden">Cancelar</button>
                <button id="modal-ok-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signature-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="close-button" id="close-signature-modal">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Assinaturas para o Recibo</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="modal-driver-signature-canvas" class="block text-gray-700 text-sm font-bold mb-2">Assinatura do Motorista:</label>
                    <canvas id="modal-driver-signature-canvas" width="300" height="100" class="signature-canvas rounded-lg shadow-sm"></canvas>
                    <button type="button" id="clear-modal-driver-signature-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg mt-2 flex items-center justify-center w-full">
                        <i class="fas fa-eraser mr-2"></i>Limpar Assinatura
                    </button>
                </div>
                <div>
                    <label for="modal-owner-signature-canvas" class="block text-gray-700 text-sm font-bold mb-2">Assinatura do Proprietário:</label>
                    <canvas id="modal-owner-signature-canvas" width="300" height="100" class="signature-canvas rounded-lg shadow-sm"></canvas>
                    <button type="button" id="clear-modal-owner-signature-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg mt-2 flex items-center justify-center w-full">
                        <i class="fas fa-eraser mr-2"></i>Limpar Assinatura
                    </button>
                </div>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="save-and-generate-recibo-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i>Salvar Assinaturas e Gerar Recibo
                </button>
                <button id="cancel-signature-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa os módulos necessários do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // CONFIGURAÇÃO DO FIREBASE FORNECIDA PELO USUÁRIO
        const firebaseConfig = {
            apiKey: "AIzaSyAdz_cTwg0N97wGIT4juTl1OXs3-HJY0X8",
            authDomain: "montero-web.firebaseapp.com",
            projectId: "montero-web",
            storageBucket: "montero-web.firebasestorage.app",
            messagingSenderId: "673171025883",
            appId: "1:673171025883:web:8e845ea1460792e54bc1fe",
            measurementId: "G-TVDL4P5J6E"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        console.log("DEBUG: Script started. Initializing Firebase app...");
        console.log("DEBUG: appId:", appId);
        console.log("DEBUG: firebaseConfig (used):", firebaseConfig);
        console.log("DEBUG: initialAuthToken:", initialAuthToken);

        // Inicializa o aplicativo Firebase APENAS UMA VEZ
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        console.log("DEBUG: Firebase app, db, and auth initialized.");

        // ID de usuário fixo para operações de dados.
        const FIXED_USER_ID = 'master'; 

        // Variáveis de estado da aplicação
        let currentUserId = null;
        let isAuthReady = false; // Indica se o estado de autenticação do Firebase foi determinado
        let unsubscribeAcertos = null;
        let unsubscribeCaixa = null;
        let unsubscribeTrucks = null;
        let allTrucks = [];
        let allAcertosData = [];
        let allCaixaData = [];
        let currentAcertoIdForSignature = null;

        // --- Referências aos Elementos do DOM ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePasswordButton = document.getElementById('togglePassword');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        
        const logoutButton = document.getElementById('logout-button');
        const companyNameSpan = document.getElementById('company-name');
        const editCompanyNameButton = document.getElementById('edit-company-name-button');
        const userIdDisplay = document.getElementById('user-id-display');

        const tabAcertos = document.getElementById('tab-acertos');
        const tabCaixa = document.getElementById('tab-caixa');
        const tabCadastroCaminhoes = document.getElementById('tab-cadastro-caminhoes');
        
        const contentAcertos = document.getElementById('content-acertos');
        const contentCaixa = document.getElementById('content-caixa');
        const contentCadastroCaminhoes = document.getElementById('content-cadastro-caminhoes');

        const acertoForm = document.getElementById('acerto-form');
        const acertoDataInput = document.getElementById('acerto-data');
        const motoristaInput = document.getElementById('motorista');
        const caminhaoSelect = document.getElementById('caminhao-select');
        const freteInput = document.getElementById('frete');
        const comissaoInput = document.getElementById('comissao');
        const formaPagamentoSelect = document.getElementById('forma-pagamento');
        const observacoesAcertoTextarea = document.getElementById('observacoes-acerto');
        const despesasContainer = document.getElementById('despesas-container');
        const addDespesaButton = document.getElementById('add-despesa-button');
        const sobraValorSpan = document.getElementById('sobra-valor');
        const saveAcertoButton = document.getElementById('save-acerto-button');
        const clearAcertoButton = document.getElementById('clear-acerto-button');
        
        const filterAcertoDataInicialInput = document.getElementById('filter-acerto-data-inicial');
        const filterAcertoDataFinalInput = document.getElementById('filter-acerto-data-final');
        const filterAcertoMotoristaInput = document.getElementById('filter-acerto-motorista');
        const filterAcertoCaminhaoSelect = document.getElementById('filter-acerto-caminhao');
        const filterAcertosButton = document.getElementById('filter-acertos-button');
        const generateAcertoReportButton = document.getElementById('generate-acerto-report-button');
        
        const totalFreteAcertosSpan = document.getElementById('total-frete-acertos');
        const totalComissaoSpan = document.getElementById('total-comissao');
        const totalDespesasAcertosSpan = document.getElementById('total-despesas-acertos');
        const totalSobraSpan = document.getElementById('total-sobra');
        const acertosTableBody = document.getElementById('acertos-table-body');

        const boletoAlertFixed = document.getElementById('boleto-alert-fixed');
        const boletoAlertMessageFixed = document.getElementById('boleto-alert-message-fixed');
        const caixaForm = document.getElementById('caixa-form');
        const caixaTipoSelect = document.getElementById('caixa-tipo');
        const caixaValorInput = document.getElementById('caixa-valor');
        const caixaCategoriaInput = document.getElementById('caixa-categoria');
        const caixaDataInput = document.getElementById('caixa-data');
        const caixaIsBoletoCheckbox = document.getElementById('caixa-is-boleto');
        const caixaIsChequeCheckbox = document.getElementById('caixa-is-cheque');
        const vencimentoField = document.getElementById('vencimento-field');
        const caixaDiasVencimentoInput = document.getElementById('caixa-dias-vencimento');
        const apresentacaoChequeField = document.getElementById('apresentacao-cheque-field');
        const caixaDiasApresentacaoChequeInput = document.getElementById('caixa-dias-apresentacao-cheque');
        const caixaNumParcelasInput = document.getElementById('caixa-num-parcelas');
        const caixaIntervaloParcelasInput = document.getElementById('caixa-intervalo-parcelas'); // Changed to text type
        const caixaDescricaoTextarea = document.getElementById('caixa-descricao');
        const caixaObservacoesTextarea = document.getElementById('caixa-observacoes');
        const saveCaixaButton = document.getElementById('save-caixa-button');
        const clearCaixaButton = document.getElementById('clear-caixa-button');
        
        const filterCaixaTipoSelect = document.getElementById('filter-caixa-tipo');
        const filterCaixaDataInicialInput = document.getElementById('filter-caixa-data-inicial');
        const filterCaixaDataFinalInput = document.getElementById('filter-caixa-data-final');
        const filterCaixaButton = document.getElementById('filter-caixa-button');
        const generateCaixaReportButton = document.getElementById('generate-caixa-report-button');
        
        const totalEntradasSpan = document.getElementById('total-entradas');
        const totalSaidasSpan = document.getElementById('total-saidas');
        const totalSaldoSpan = document.getElementById('total-saldo');
        const caixaTableBody = document.getElementById('caixa-table-body');

        const truckRegistrationForm = document.getElementById('truck-registration-form');
        const truckNameInput = document.getElementById('truck-name');
        const truckPlateInput = document.getElementById('truck-plate');
        const saveTruckButton = document.getElementById('save-truck-button');
        const clearTruckButton = document.getElementById('clear-truck-button');
        const trucksTableBody = document.getElementById('trucks-table-body');

        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalOkButton = document.getElementById('modal-ok-button');
        const closeModalButton = customModal.querySelector('.close-button');

        const signatureModal = document.getElementById('signature-modal');
        const closeSignatureModalButton = document.getElementById('close-signature-modal');
        const modalDriverSignatureCanvas = document.getElementById('modal-driver-signature-canvas');
        const modalDriverSignatureCtx = modalDriverSignatureCanvas.getContext('2d');
        const clearModalDriverSignatureButton = document.getElementById('clear-modal-driver-signature-button');
        const modalOwnerSignatureCanvas = document.getElementById('modal-owner-signature-canvas');
        const modalOwnerSignatureCtx = modalOwnerSignatureCanvas.getContext('2d');
        const clearModalOwnerSignatureButton = document.getElementById('clear-modal-owner-signature-button');
        const saveAndGenerateReciboButton = document.getElementById('save-and-generate-recibo-button');
        const cancelSignatureButton = document.getElementById('cancel-signature-button');

        let resolveModalPromise;

        /**
         * Exibe um modal personalizado com uma mensagem e botões configuráveis.
         * @param {string} message - A mensagem a ser exibida no modal.
         * @param {'alert'|'confirm'} type - O tipo de modal ('alert' para OK, 'confirm' para Confirmar/Cancelar).
         * @returns {Promise<boolean>} - Uma promessa que resolve para true se confirmado/OK, false se cancelado.
         */
        function showModal(message, type = 'alert') {
            modalMessage.innerHTML = message;
            modalConfirmButton.classList.add('hidden');
            modalCancelButton.classList.add('hidden');
            modalOkButton.classList.add('hidden');

            if (type === 'confirm') {
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');
            } else {
                modalOkButton.classList.remove('hidden');
            }

            customModal.style.display = 'flex';

            return new Promise((resolve) => {
                resolveModalPromise = resolve;
            });
        }

        modalOkButton.onclick = () => {
            customModal.style.display = 'none';
            if (resolveModalPromise) resolveModalPromise(true);
        };
        modalConfirmButton.onclick = () => {
            customModal.style.display = 'none';
            if (resolveModalPromise) resolveModalPromise(true);
        };
        modalCancelButton.onclick = () => {
            customModal.style.display = 'none';
            if (resolveModalPromise) resolveModalPromise(false);
        };
        closeModalButton.onclick = () => {
            customModal.style.display = 'none';
            if (resolveModalPromise) resolveModalPromise(false);
        };
        window.onclick = (event) => {
            if (event.target == customModal) {
                customModal.style.display = 'none';
                if (resolveModalPromise) resolveModalPromise(false);
            }
        };

        /**
         * Listener de mudança de estado de autenticação do Firebase.
         * Gerencia a visibilidade das telas de login e aplicação.
         * É a única fonte de verdade para o estado 'isAuthReady'.
         */
        onAuthStateChanged(auth, async (user) => {
            console.log("DEBUG: onAuthStateChanged callback triggered. User object:", user);
            if (user) {
                console.log("DEBUG: onAuthStateChanged: User is authenticated. UID:", user.uid);
                currentUserId = user.uid;
                userIdDisplay.textContent = `ID do Usuário: ${currentUserId} (Dados agrupados sob: ${FIXED_USER_ID})`;
                isAuthReady = true; // O Firebase está autenticado
                loadCompanyName();
                // A visibilidade da aba de caminhões será controlada após o login local do 'master'
                // para evitar que apareça antes do usuário ter se autenticado localmente.
                console.log("DEBUG: Auth ready. Setting up real-time listeners...");
                setupRealtimeListeners(); // Chama os listeners uma vez que o Firebase está autenticado
            } else {
                console.log("DEBUG: onAuthStateChanged: User is NOT authenticated (null user).");
                currentUserId = null;
                isAuthReady = true; // O estado de autenticação do Firebase é conhecido (não autenticado)
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                tabCadastroCaminhoes.classList.add('hidden'); // Esconde a aba de caminhões se não estiver logado
                // Cancela todos os listeners em tempo real para evitar vazamentos de memória
                if (unsubscribeAcertos) { unsubscribeAcertos(); unsubscribeAcertos = null; console.log("DEBUG: Unsubscribed from Acertos listener."); }
                if (unsubscribeCaixa) { unsubscribeCaixa(); unsubscribeCaixa = null; console.log("DEBUG: Unsubscribed from Caixa listener."); }
                if (unsubscribeTrucks) { unsubscribeTrucks(); unsubscribeTrucks = null; console.log("DEBUG: Unsubscribed from Caminhões listener."); }
                // Limpa as tabelas ao fazer logout
                acertosTableBody.innerHTML = '';
                caixaTableBody.innerHTML = '';
                trucksTableBody.innerHTML = '';
                boletoAlertFixed.style.display = 'none';
            }
        });

        /**
         * Tenta autenticar o usuário ao iniciar a aplicação com o token personalizado.
         * Se não houver token ou se a autenticação falhar, não tenta login anônimo.
         */
        async function initialAuthAttempt() {
            console.log("DEBUG: initialAuthAttempt() called.");
            console.log("DEBUG: __app_id:", typeof __app_id !== 'undefined' ? __app_id : 'undefined');
            console.log("DEBUG: __initial_auth_token:", typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : 'undefined');

            try {
                if (initialAuthToken && initialAuthToken !== 'undefined' && initialAuthToken !== 'null') {
                    console.log("DEBUG: Attempting to sign in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("DEBUG: Custom token sign-in successful.");
                } else {
                    console.warn("DEBUG: No custom initial auth token provided. Firebase authentication will not be performed automatically. App will require manual 'master' login and successful Firebase auth to proceed.");
                    // Não há tentativa de login anônimo automático aqui. O onAuthStateChanged lidará com o estado.
                }
            } catch (error) {
                console.error("DEBUG: Error during initial authentication attempt with custom token:", error.code, error.message);
                // No modal here, just let the login screen show
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                isAuthReady = false;
            }
        }

        initialAuthAttempt(); // Chama a função de tentativa de autenticação inicial

        // Listener para o botão de login
        loginButton.addEventListener('click', async () => {
            console.log("DEBUG: Login button clicked.");
            const username = usernameInput.value;
            const password = passwordInput.value;

            // Validação de credenciais locais (apenas para o usuário 'master')
            if (username === 'master' && password === '123mudar') {
                console.log("DEBUG: Local credentials are valid (master user).");
                loginError.classList.add('hidden');

                // Se o Firebase não estiver autenticado, tenta autenticar anonimamente
                if (!auth.currentUser) {
                    try {
                        console.log("DEBUG: Firebase user is null. Attempting anonymous sign-in...");
                        await signInAnonymously(auth);
                        console.log("DEBUG: Anonymous sign-in successful. onAuthStateChanged will handle UI.");
                        // The onAuthStateChanged listener will now trigger and set isAuthReady to true
                        // and transition the UI.
                    } catch (error) {
                        console.error("DEBUG: Error during anonymous sign-in after local master login:", error.code, error.message);
                        showModal(`Erro ao autenticar no Firebase. Detalhes: ${error.message}. Tente novamente.`);
                        return; // Stop here if Firebase auth fails
                    }
                } else {
                    console.log("DEBUG: Firebase user already authenticated. Proceeding to main screen.");
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    isAuthReady = true; // Ensure this is true if already authenticated
                    loadCompanyName();
                    tabCadastroCaminhoes.classList.remove('hidden'); // Show for master
                    setupRealtimeListeners(); // Ensure listeners are set up
                }
            } else {
                loginError.classList.remove('hidden');
                showModal("Usuário ou senha inválidos.");
                console.log("DEBUG: Invalid username or password entered.");
            }
        });

        // Listener para o botão de alternar visibilidade da senha
        togglePasswordButton.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordButton.querySelector('i').classList.toggle('fa-eye');
            togglePasswordButton.querySelector('i').classList.toggle('fa-eye-slash');
        });

        // Listener para o botão de logout
        logoutButton.addEventListener('click', async () => {
            try {
                console.log("DEBUG: Attempting logout...");
                await signOut(auth); // Desloga o usuário do Firebase
                showModal("Você foi desconectado com sucesso.");
            } catch (error) {
                console.error("DEBUG: Error during logout:", error.code, error.message);
                showModal(`Erro ao fazer logout. Tente novamente. Detalhes: ${error.message}`);
            }
        });

        // --- Configuração do Nome da Empresa ---
        /**
         * Carrega o nome da empresa do localStorage ou usa um valor padrão.
         */
        function loadCompanyName() {
            const companyName = localStorage.getItem('companyName') || 'Transportes - Sistema de Acertos';
            companyNameSpan.textContent = companyName;
        }

        // Listener para o botão de editar nome da empresa
        editCompanyNameButton.addEventListener('click', async () => {
            const currentName = companyNameSpan.textContent;
            const newName = prompt("Digite o novo nome da empresa:", currentName);
            if (newName !== null && newName.trim() !== '') {
                localStorage.setItem('companyName', newName.trim());
                loadCompanyName();
                showModal("Nome da empresa atualizado!");
            } else if (newName !== null) {
                showModal("O nome da empresa não pode ser vazio.");
            }
        });

        // --- Navegação por Abas ---
        /**
         * Ativa a aba especificada e desativa as outras.
         * @param {string} tabId - O ID do botão da aba a ser ativada (ex: 'tab-acertos').
         */
        function activateTab(tabId) {
            // Remove a classe 'active-tab' e estilos de todas as abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active-tab', 'text-blue-600');
                button.classList.add('text-gray-600');
            });
            // Esconde todo o conteúdo das abas
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Ativa a aba clicada e mostra seu conteúdo
            document.getElementById(tabId).classList.add('active-tab', 'text-blue-600');
            document.getElementById(`content-${tabId.replace('tab-', '')}`).classList.add('active');
        }

        // Listeners para os botões das abas
        tabAcertos.addEventListener('click', () => activateTab('tab-acertos'));
        tabCaixa.addEventListener('click', () => activateTab('tab-caixa'));
        tabCadastroCaminhoes.addEventListener('click', () => activateTab('tab-cadastro-caminhoes'));

        // --- Formatação de Moeda ---
        /**
         * Formata um valor numérico em um campo de entrada para o formato de moeda brasileira (BRL).
         * @param {HTMLInputElement} input - O elemento de entrada a ser formatado.
         */
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não for dígito
            if (value === '') {
                input.value = '';
                return;
            }
            // Converte para número, divide por 100 (para centavos) e formata para moeda brasileira
            value = (parseInt(value) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            input.value = value;
        }

        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('input', () => formatCurrency(input));
            if (input.value) {
                formatCurrency(input);
            }
        });

        // Custom formatting for negative currency values (R$ - X,XX)
        function formatNegativeCurrency(value) {
            if (value >= 0) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                const absoluteValue = Math.abs(value);
                return `R$ - ${absoluteValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        }

        // --- Funções Auxiliares de Data ---
        /**
         * Formata uma string de data (YYYY-MM-DD) para DD/MM/YYYY.
         * @param {string} dateString - A string de data no formato YYYY-MM-DD.
         * @returns {string} A data formatada em DD/MM/YYYY ou 'N/A' se inválida.
         */
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return 'N/A';
            try {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.error("DEBUG: Erro ao formatar data:", dateString, e);
                return dateString;
            }
        }

        /**
         * Adiciona um número de dias a uma data e retorna a nova data no formato YYYY-MM-DD.
         * @param {string} dateString - A data inicial (YYYY-MM-DD).
         * @param {number} days - O número de dias a adicionar.
         * @returns {string} A nova data no formato YYYY-MM-DD.
         */
        function addDaysToDate(dateString, days) {
            const date = new Date(dateString + 'T00:00:00'); // Garante que a data seja interpretada como local
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        // --- Lógica da Aba de Acertos de Viagem ---
        let expenseCount = 0;

        /**
         * Adiciona um novo campo de despesa ao formulário de acerto.
         * @param {string} description - Descrição inicial da despesa.
         * @param {string} value - Valor inicial da despesa.
         */
        function addDespesaField(description = '', value = '') {
            const div = document.createElement('div');
            div.classList.add('flex', 'items-center', 'gap-2', 'mb-2');
            div.innerHTML = `
                <input type="text" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline despesa-descricao" placeholder="Descrição da Despesa" value="${description}">
                <input type="text" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline currency-input despesa-valor" placeholder="Valor (R$)" value="${value}">
                <button type="button" class="remove-despesa-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            despesasContainer.appendChild(div);

            const newDespesaValorInput = div.querySelector('.despesa-valor');
            newDespesaValorInput.addEventListener('input', () => {
                formatCurrency(newDespesaValorInput);
                calculateSobra();
            });
            if (value) {
                formatCurrency(newDespesaValorInput);
            }

            div.querySelector('.remove-despesa-button').addEventListener('click', () => {
                div.remove();
                calculateSobra();
            });

            expenseCount++;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (despesasContainer.children.length === 0) {
                addDespesaField();
            }
        });

        addDespesaButton.addEventListener('click', () => addDespesaField());

        /**
         * Calcula a "sobra" (valor restante) do acerto com base no frete, comissão e despesas.
         */
        function calculateSobra() {
            const frete = parseFloat(freteInput.value.replace(/\D/g, '')) / 100 || 0;
            const comissao = parseFloat(comissaoInput.value.replace(/\D/g, '')) / 100 || 0;
            let totalDespesas = 0;
            document.querySelectorAll('.despesa-valor').forEach(input => {
                totalDespesas += parseFloat(input.value.replace(/\D/g, '')) / 100 || 0;
            });

            const sobra = frete - comissao - totalDespesas;
            sobraValorSpan.textContent = sobra.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        freteInput.addEventListener('input', calculateSobra);
        comissaoInput.addEventListener('input', calculateSobra);

        /**
         * Limpa todos os campos do formulário de acerto.
         */
        function clearAcertoForm() {
            acertoDataInput.value = '';
            motoristaInput.value = '';
            caminhaoSelect.value = '';
            freteInput.value = '';
            comissaoInput.value = '';
            formaPagamentoSelect.value = 'Dinheiro';
            observacoesAcertoTextarea.value = '';
            despesasContainer.innerHTML = '';
            addDespesaField();
            sobraValorSpan.textContent = 'R$ 0,00';
            expenseCount = 0;
            if (saveAcertoButton) {
                saveAcertoButton.textContent = 'Salvar Acerto';
                const icon = saveAcertoButton.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-sync-alt');
                    icon.classList.add('fa-save');
                }
                delete saveAcertoButton.dataset.editId;
            }
        }

        clearAcertoButton.addEventListener('click', clearAcertoForm);

        // --- Lógica do Canvas de Assinatura (Reutilizável) ---
        let isDrawingModalDriver = false;
        let lastXModalDriver = 0;
        let lastYModalDriver = 0;

        let isDrawingModalOwner = false;
        let lastXModalOwner = 0;
        let lastYModalOwner = 0;

        /**
         * Configura as propriedades de desenho para um contexto de canvas.
         * @param {CanvasRenderingContext2D} ctx - O contexto 2D do canvas.
         */
        function setupSignatureContext(ctx) {
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
        }

        /**
         * Obtém as coordenadas X e Y do evento em relação a um canvas específico.
         * @param {Event} e - O evento (mouse ou touch).
         * @param {HTMLCanvasElement} canvas - O elemento canvas.
         * @returns {Array<number>} Um array [x, y] das coordenadas.
         */
        function getCoordinates(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return [clientX - rect.left, clientY - rect.top];
        }

        /**
         * Limpa todo o conteúdo de um canvas de assinatura.
         * @param {CanvasRenderingContext2D} ctx - O contexto 2D do canvas.
         * @param {HTMLCanvasElement} canvas - O elemento canvas.
         * @param {boolean} returnBlankDataUrl - Se verdadeiro, retorna a URL de dados de um canvas em branco.
         */
        function clearSignatureCanvas(ctx, canvas, returnBlankDataUrl = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (returnBlankDataUrl) {
                return canvas.toDataURL('image/png');
            }
        }

        // --- Inicialização e Listeners para Assinatura do Motorista (Modal) ---
        setupSignatureContext(modalDriverSignatureCtx);
        clearSignatureCanvas(modalDriverSignatureCtx, modalDriverSignatureCanvas);
        modalDriverSignatureCanvas.addEventListener('mousedown', (e) => {
            isDrawingModalDriver = true;
            [lastXModalDriver, lastYModalDriver] = getCoordinates(e, modalDriverSignatureCanvas);
            modalDriverSignatureCtx.beginPath();
            modalDriverSignatureCtx.moveTo(lastXModalDriver, lastYModalDriver);
        });
        modalDriverSignatureCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawingModalDriver) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e, modalDriverSignatureCanvas);
            modalDriverSignatureCtx.lineTo(x, y);
            modalDriverSignatureCtx.stroke();
            lastXModalDriver = x;
            lastYModalDriver = y;
        });
        modalDriverSignatureCanvas.addEventListener('mouseup', () => {
            isDrawingModalDriver = false;
        });
        modalDriverSignatureCanvas.addEventListener('mouseout', () => {
            isDrawingModalDriver = false;
        });
        modalDriverSignatureCanvas.addEventListener('touchstart', (e) => {
            isDrawingModalDriver = true;
            [lastXModalDriver, lastYModalDriver] = getCoordinates(e, modalDriverSignatureCanvas);
            modalDriverSignatureCtx.beginPath();
            modalDriverSignatureCtx.moveTo(lastXModalDriver, lastYModalDriver);
        });
        modalDriverSignatureCanvas.addEventListener('touchmove', (e) => {
            if (!isDrawingModalDriver) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e, modalDriverSignatureCanvas);
            modalDriverSignatureCtx.lineTo(x, y);
            modalDriverSignatureCtx.stroke();
            lastXModalDriver = x;
            lastYModalDriver = y;
        });
        modalDriverSignatureCanvas.addEventListener('touchend', () => {
            isDrawingModalDriver = false;
        });
        modalDriverSignatureCanvas.addEventListener('touchcancel', () => {
            isDrawingModalDriver = false;
        });
        clearModalDriverSignatureButton.addEventListener('click', () => clearSignatureCanvas(modalDriverSignatureCtx, modalDriverSignatureCanvas));

        // --- Inicialização e Listeners para Assinatura do Proprietário (Modal) ---
        setupSignatureContext(modalOwnerSignatureCtx);
        clearSignatureCanvas(modalOwnerSignatureCtx, modalOwnerSignatureCanvas);
        modalOwnerSignatureCanvas.addEventListener('mousedown', (e) => {
            isDrawingModalOwner = true;
            [lastXModalOwner, lastYModalOwner] = getCoordinates(e, modalOwnerSignatureCanvas);
            modalOwnerSignatureCtx.beginPath();
            modalOwnerSignatureCtx.moveTo(lastXModalOwner, lastYModalOwner);
        });
        modalOwnerSignatureCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawingModalOwner) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e, modalOwnerSignatureCanvas);
            modalOwnerSignatureCtx.lineTo(x, y);
            modalOwnerSignatureCtx.stroke();
            lastXModalOwner = x;
            lastYModalOwner = y;
        });
        modalOwnerSignatureCanvas.addEventListener('mouseup', () => {
            isDrawingModalOwner = false;
        });
        modalOwnerSignatureCanvas.addEventListener('mouseout', () => {
            isDrawingModalOwner = false;
        });
        modalOwnerSignatureCanvas.addEventListener('touchstart', (e) => {
            isDrawingModalOwner = true;
            [lastXModalOwner, lastYModalOwner] = getCoordinates(e, modalOwnerSignatureCanvas);
            modalOwnerSignatureCtx.beginPath();
            modalOwnerSignatureCtx.moveTo(lastXModalOwner, lastYModalOwner);
        });
        modalOwnerSignatureCanvas.addEventListener('touchmove', (e) => {
            if (!isDrawingModalOwner) return;
            e.preventDefault();
            const [x, y] = getCoordinates(e, modalOwnerSignatureCanvas);
            modalOwnerSignatureCtx.lineTo(x, y);
            modalOwnerSignatureCtx.stroke();
            lastXModalOwner = x;
            lastYModalOwner = y;
        });
        modalOwnerSignatureCanvas.addEventListener('touchend', () => {
            isDrawingModalOwner = false;
        });
        modalOwnerSignatureCanvas.addEventListener('touchcancel', () => {
            isDrawingModalOwner = false;
        });
        clearModalOwnerSignatureButton.addEventListener('click', () => clearSignatureCanvas(modalOwnerSignatureCtx, modalOwnerSignatureCanvas));

        // Listener para o envio do formulário de acerto
        acertoForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            const data = acertoDataInput.value;
            const motorista = motoristaInput.value.trim();
            const caminhao = caminhaoSelect.value;
            const frete = parseFloat(freteInput.value.replace(/\D/g, '')) / 100 || 0;
            const comissao = parseFloat(comissaoInput.value.replace(/\D/g, '')) / 100 || 0;
            const formaPagamento = formaPagamentoSelect.value;
            const observacoes = observacoesAcertoTextarea.value.trim();

            if (!data || !motorista || !caminhao || frete <= 0) {
                showModal("Por favor, preencha os campos obrigatórios: Data, Motorista, Caminhão e Valor do Frete.");
                return;
            }

            const despesas = [];
            document.querySelectorAll('#despesas-container > div').forEach(div => {
                const descricao = div.querySelector('.despesa-descricao').value.trim();
                const valor = parseFloat(div.querySelector('.despesa-valor').value.replace(/\D/g, '')) / 100 || 0;
                if (descricao && valor > 0) {
                    despesas.push({ descricao, valor });
                }
            });

            const totalDespesas = despesas.reduce((sum, d) => sum + d.valor, 0);
            const sobra = frete - comissao - totalDespesas;

            const acertoData = {
                data: data,
                motorista: motorista,
                caminhao: caminhao,
                frete: frete,
                comissao: comissao,
                formaPagamento: formaPagamento,
                observacoes: observacoes,
                despesas: despesas,
                totalDespesas: totalDespesas,
                sobra: sobra,
                driverSignatureImage: '',
                ownerSignatureImage: '',
                timestamp: new Date()
            };

            const editId = saveAcertoButton.dataset.editId;

            try {
                const acertosCollectionRef = collection(db, `artifacts/${appId}/public/data/acertos`);
                const caixaCollectionRef = collection(db, `artifacts/${appId}/public/data/caixa`);

                if (editId) {
                    console.log(`DEBUG: Starting update of settlement with ID: ${editId}`);
                    const existingAcertoDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/acertos`, editId));
                    const existingAcertoData = existingAcertoDoc.exists() ? existingAcertoDoc.data() : {};
                    
                    const updatedAcertoData = {
                        ...acertoData,
                        driverSignatureImage: existingAcertoData.driverSignatureImage || '',
                        ownerSignatureImage: existingAcertoData.ownerSignatureImage || ''
                    };

                    console.log("DEBUG: Payload for Firestore (settlement update):", updatedAcertoData);
                    const docRef = doc(db, `artifacts/${appId}/public/data/acertos`, editId);
                    await updateDoc(docRef, updatedAcertoData);
                    console.log("DEBUG: Settlement updated in Firestore:", editId);

                    console.log(`DEBUG: Searching and deleting old 'sobra' or 'falta' caixa entries linked to settlement ${editId}...`);
                    const oldSobraFaltaCaixaQuery = query(caixaCollectionRef, where('acertoLinkedId', '==', editId), where('categoria', 'in', ['Sobra de Acerto', 'Falta de Acerto']));
                    const oldSobraFaltaCaixaSnapshot = await getDocs(oldSobraFaltaCaixaQuery);
                    const deleteSobraFaltaPromises = [];
                    oldSobraFaltaCaixaSnapshot.forEach(doc => {
                        console.log(`DEBUG: Deleting sobra/falta caixa entry ID: ${doc.id}`);
                        deleteSobraFaltaPromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deleteSobraFaltaPromises);
                    console.log("DEBUG: Old linked sobra/falta caixa entries deleted for settlement:", editId);

                    if (sobra > 0) {
                        console.log(`DEBUG: Creating new 'sobra' caixa entry for settlement ${editId}...`);
                        await addDoc(caixaCollectionRef, {
                            tipo: 'entrada',
                            valor: sobra,
                            categoria: 'Sobra de Acerto',
                            data: data,
                            descricao: `Sobra do acerto de viagem - ${motorista} / ${caminhao}`,
                            acertoLinkedId: editId,
                            timestamp: new Date(),
                            pago: true,
                            isBoleto: false,
                            isCheque: false,
                            vencimento: '',
                            apresentacaoCheque: ''
                        });
                        console.log("DEBUG: New linked sobra caixa entry created for settlement:", editId);
                    } else if (sobra < 0) {
                         console.log(`DEBUG: Creating new 'falta' caixa entry for settlement ${editId}...`);
                        await addDoc(caixaCollectionRef, {
                            tipo: 'saida',
                            valor: Math.abs(sobra),
                            categoria: 'Falta de Acerto',
                            data: data,
                            descricao: `Falta do acerto de viagem - ${motorista} / ${caminhao}`,
                            acertoLinkedId: editId,
                            timestamp: new Date(),
                            pago: false,
                            isBoleto: false,
                            isCheque: false,
                            vencimento: '',
                            apresentacaoCheque: ''
                        });
                        console.log("DEBUG: New linked falta caixa entry created for settlement:", editId);
                    }

                    showModal("Acerto atualizado com sucesso!");

                } else {
                    console.log("DEBUG: Starting save of a new settlement...");
                    console.log("DEBUG: Payload for Firestore (new settlement):", acertoData);
                    const acertoDocRef = await addDoc(acertosCollectionRef, acertoData);
                    const newAcertoId = acertoDocRef.id;
                    console.log("DEBUG: New settlement saved in Firestore with ID:", newAcertoId);

                    if (sobra > 0) {
                        console.log(`DEBUG: Creating 'sobra' caixa entry for new settlement ${newAcertoId}...`);
                        await addDoc(caixaCollectionRef, {
                            tipo: 'entrada',
                            valor: sobra,
                            categoria: 'Sobra de Acerto',
                            data: data,
                            descricao: `Sobra do acerto de viagem - ${motorista} / ${caminhao}`,
                            acertoLinkedId: newAcertoId,
                            timestamp: new Date(),
                            pago: true,
                            isBoleto: false,
                            isCheque: false,
                            vencimento: '',
                            apresentacaoCheque: ''
                        });
                        console.log("DEBUG: New linked sobra caixa entry created for settlement:", newAcertoId);
                    } else if (sobra < 0) {
                        console.log(`DEBUG: Creating 'falta' caixa entry for new settlement ${newAcertoId}...`);
                        await addDoc(caixaCollectionRef, {
                            tipo: 'saida',
                            valor: Math.abs(sobra),
                            categoria: 'Falta de Acerto',
                            data: data,
                            descricao: `Falta do acerto de viagem - ${motorista} / ${caminhao}`,
                            acertoLinkedId: newAcertoId,
                            timestamp: new Date(),
                            pago: false,
                            isBoleto: false,
                            isCheque: false,
                            vencimento: '',
                            apresentacaoCheque: ''
                        });
                        console.log("DEBUG: New linked falta caixa entry created for settlement:", newAcertoId);
                    }
                    showModal("Acerto salvo com sucesso!");
                }
                clearAcertoForm();

            } catch (e) {
                console.error("DEBUG: Error saving/updating settlement: ", e.message, e);
                showModal("Erro ao salvar/atualizar acerto. Tente novamente.");
            }
        });

        /**
         * Configura o listener em tempo real para a coleção de acertos no Firestore.
         * Atualiza a tabela de acertos e os totalizadores sempre que há uma mudança.
         */
        function setupAcertosListener() {
            if (unsubscribeAcertos) unsubscribeAcertos(); // Cancela o listener anterior, se houver

            if (!isAuthReady) {
                console.warn("DEBUG: Sistema de autenticação não pronto para o listener de acertos. Pulando a configuração.");
                return;
            }
            console.log("DEBUG: Setting up Settlements listener for fixed user:", FIXED_USER_ID);

            const acertosCollectionRef = collection(db, `artifacts/${appId}/public/data/acertos`);
            const q = query(acertosCollectionRef);

            unsubscribeAcertos = onSnapshot(q, (snapshot) => {
                allAcertosData = [];
                snapshot.forEach(doc => {
                    allAcertosData.push({ id: doc.id, ...doc.data() });
                });
                console.log("DEBUG: All settlements loaded successfully:", allAcertosData.length, "entries.");
                const filteredAcertos = getFilteredAcertos(allAcertosData);
                renderAcertosTable(filteredAcertos);
                calculateAcertosTotals(filteredAcertos);
            }, (error) => {
                console.error("DEBUG: Error loading settlements: ", error.message, error);
                showModal("Erro ao carregar acertos.");
            });
        }

        /**
         * Retorna uma lista de acertos filtrados com base nas entradas de filtro atuais.
         * @param {Array<Object>} acertos - A lista completa de acertos.
         * @returns {Array<Object>} A lista de acertos filtrados.
         */
        function getFilteredAcertos(acertos) {
            const sortedAcertos = [...acertos].sort((a, b) => new Date(b.data + "T00:00:00") - new Date(a.data + "T00:00:00"));

            const filterStartDate = filterAcertoDataInicialInput.value ? new Date(filterAcertoDataInicialInput.value + "T00:00:00") : null;
            const filterEndDate = filterAcertoDataFinalInput.value ? new Date(filterAcertoDataFinalInput.value + "T00:00:00") : null;
            const filterMotorista = filterAcertoMotoristaInput.value.trim().toLowerCase();
            const filterCaminhao = filterAcertoCaminhaoSelect.value;

            const filteredAcertos = sortedAcertos.filter(acerto => {
                const acertoDate = new Date(acerto.data + "T00:00:00");
                acertoDate.setHours(0,0,0,0);
                let matchesFilter = true;

                if (filterStartDate && acertoDate < filterStartDate) matchesFilter = false;
                if (filterEndDate && acertoDate > filterEndDate) matchesFilter = false;
                
                if (filterMotorista && !acerto.motorista.toLowerCase().includes(filterMotorista)) matchesFilter = false;
                
                if (filterCaminhao && filterCaminhao !== '' && acerto.caminhao !== filterCaminhao) {
                    matchesFilter = false;
                }

                return matchesFilter;
            });
            return filteredAcertos;
        }

        /**
         * Renderiza a tabela de acertos com base nos dados fornecidos.
         * @param {Array<Object>} acertosToRender - Uma lista de objetos de acerto já filtrados.
         */
        function renderAcertosTable(acertosToRender) {
            acertosTableBody.innerHTML = '';

            if (acertosToRender.length === 0) {
                acertosTableBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center">Nenhum acerto encontrado.</td></tr>`;
                return;
            }

            acertosToRender.forEach(acerto => {
                const row = acertosTableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${formatDateToDDMMYYYY(acerto.data)}</td>
                    <td class="py-3 px-6 text-left">${acerto.motorista}</td>
                    <td class="py-3 px-6 text-left">${acerto.caminhao}</td>
                    <td class="py-3 px-6 text-left">${(acerto.frete ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="py-3 px-6 text-left">${(acerto.comissao ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="py-3 px-6 text-left">${(acerto.sobra ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <button class="edit-acerto-button text-blue-500 hover:text-blue-700 mr-2" data-id="${acerto.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-acerto-button text-red-500 hover:text-red-700 mr-2" data-id="${acerto.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                        <button class="view-acerto-button text-green-500 hover:text-green-700" data-id="${acerto.id}" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                        <button class="generate-recibo-button text-purple-500 hover:text-purple-700 ml-2" data-id="${acerto.id}" title="Gerar Recibo"><i class="fas fa-receipt"></i></button>
                    </td>
                `;
            });

            document.querySelectorAll('.edit-acerto-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await editAcerto(id);
                });
            });
            document.querySelectorAll('.delete-acerto-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const confirmed = await showModal("Tem certeza que deseja excluir este acerto?", 'confirm');
                    if (confirmed) {
                        await deleteAcertoAndCaixa(id);
                    }
                });
            });
            document.querySelectorAll('.view-acerto-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await viewAcertoDetails(id);
                });
            });
            document.querySelectorAll('.generate-recibo-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await openSignatureModal(id);
                });
            });
        }

        /**
         * Calcula e exibe os totais de frete, comissão, despesas e valor restante dos acertos filtrados.
         * @param {Array<Object>} acertosToCalculate - Uma lista de objetos de acerto já filtrados.
         */
        function calculateAcertosTotals(acertosToCalculate) {
            let totalFrete = 0;
            let totalComissao = 0;
            let totalDespesas = 0;
            let totalSobra = 0;

            acertosToCalculate.forEach(acerto => {
                totalFrete += acerto.frete || 0;
                totalComissao += acerto.comissao || 0;
                totalDespesas += acerto.totalDespesas || 0;
                totalSobra += acerto.sobra || 0;
            });

            totalFreteAcertosSpan.textContent = totalFrete.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            totalComissaoSpan.textContent = totalComissao.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            totalDespesasAcertosSpan.textContent = totalDespesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            totalSobraSpan.textContent = totalSobra.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        filterAcertosButton.addEventListener('click', () => {
            if (isAuthReady) {
                const filteredAcertos = getFilteredAcertos(allAcertosData);
                renderAcertosTable(filteredAcertos);
                calculateAcertosTotals(filteredAcertos);
            }
        });
        filterAcertoMotoristaInput.addEventListener('input', () => {
            if (isAuthReady) {
                const filteredAcertos = getFilteredAcertos(allAcertosData);
                renderAcertosTable(filteredAcertos);
                calculateAcertosTotals(filteredAcertos);
            }
        });
        filterAcertoCaminhaoSelect.addEventListener('change', () => {
            if (isAuthReady) {
                const filteredAcertos = getFilteredAcertos(allAcertosData);
                renderAcertosTable(filteredAcertos);
                calculateAcertosTotals(filteredAcertos);
            }
        });


        /**
         * Carrega os dados de um acerto específico no formulário para edição.
         * @param {string} id - O ID do documento de acerto no Firestore.
         */
        async function editAcerto(id) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/acertos`, id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal("Acerto não encontrado.");
                    return;
                }

                const acerto = docSnap.data();
                console.log("DEBUG: Settlement loaded =>", acerto);

                acertoDataInput.value = acerto.data || '';
                motoristaInput.value = acerto.motorista || '';
                caminhaoSelect.value = acerto.caminhao || '';
                freteInput.value = Number(acerto.frete ?? 0).toFixed(2).replace('.', ',');
                comissaoInput.value = Number(acerto.comissao ?? 0).toFixed(2).replace('.', ',');
                formaPagamentoSelect.value = acerto.formaPagamento || 'Dinheiro';
                observacoesAcertoTextarea.value = acerto.observacoes || '';

                despesasContainer.innerHTML = '';
                if (Array.isArray(acerto.despesas) && acerto.despesas.length > 0) {
                    acerto.despesas.forEach(d => {
                        addDespesaField(d.descricao || '', Number(d.valor ?? 0).toFixed(2).replace('.', ','));
                    });
                } else {
                    addDespesaField();
                }
                
                calculateSobra();

                if (saveAcertoButton) {
                    saveAcertoButton.textContent = 'Atualizar Acerto';
                    const icon = saveAcertoButton.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-save');
                        icon.classList.add('fa-sync-alt');
                    }
                    saveAcertoButton.dataset.editId = id;
                }

                acertoForm.scrollIntoView({ behavior: 'smooth' });
                showModal("Acerto carregado para edição.");
            } catch (error) {
                console.error("DEBUG: Error loading settlement:", error.message, error);
                showModal("Erro ao carregar acerto para edição. Detalhes no console.");
            }
        }

        /**
         * Exclui um acerto e suas entradas de caixa vinculadas (sobra/falta).
         * @param {string} id - O ID do documento de acerto a ser excluído.
         */
        async function deleteAcertoAndCaixa(id) {
            if (!isAuthReady) return;

            try {
                console.log(`DEBUG: Starting deletion of settlement with ID: ${id} and its linked caixa entries.`);
                const caixaCollectionRef = collection(db, `artifacts/${appId}/public/data/caixa`);
                const linkedCaixaQuery = query(caixaCollectionRef, where('acertoLinkedId', '==', id), where('categoria', 'in', ['Sobra de Acerto', 'Falta de Acerto']));
                const linkedCaixaSnapshot = await getDocs(linkedCaixaQuery);
                const deleteCaixaPromises = []; 
                linkedCaixaSnapshot.forEach(doc => {
                    console.log(`DEBUG: Deleting caixa entry ID: ${doc.id}`);
                    deleteCaixaPromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deleteCaixaPromises);
                console.log("DEBUG: Linked caixa entries (sobra/falta) deleted for settlement:", id);

                const acertoDocRef = doc(db, `artifacts/${appId}/public/data/acertos`, id);
                await deleteDoc(acertoDocRef);
                console.log("DEBUG: Settlement deleted from Firestore:", id);
                showModal("Acerto e lançamentos de caixa relacionados excluídos com sucesso!");
            } catch (error) {
                console.error("DEBUG: Error deleting settlement and caixa entries: ", error.message, error);
                showModal("Erro ao excluir acerto e lançamentos de caixa. Tente novamente.");
            }
        }

        /**
         * Exibe os detalhes de um acerto em um modal.
         * @param {string} id - O ID do documento de acerto.
         */
        async function viewAcertoDetails(id) {
            if (!isAuthReady) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/acertos`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const acerto = docSnap.data();
                    let details = `
                        <p><strong>Data:</strong> ${formatDateToDDMMYYYY(acerto.data)}</p>
                        <p><strong>Motorista:</strong> ${acerto.motorista}</p>
                        <p><strong>Caminhão:</strong> ${acerto.caminhao}</p>
                        <p><strong>Frete:</strong> ${(acerto.frete ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p><strong>Comissão:</strong> ${(acerto.comissao ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p><strong>Forma de Pagamento:</strong> ${acerto.formaPagamento}</p>
                        <p><strong>Observações:</strong> ${acerto.observacoes || 'N/A'}</p>
                        <p><strong>Despesas:</strong></p>
                        <ul>
                    `;
                    if (Array.isArray(acerto.despesas) && acerto.despesas.length > 0) {
                        acerto.despesas.forEach(d => {
                            details += `<li>- ${d.descricao}: ${(d.valor ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</li>`;
                        });
                    } else {
                        details += `<li>Nenhuma despesa registrada.</li>`;
                    }
                    details += `
                        </ul>
                        <p><strong>Total Despesas:</strong> ${(acerto.totalDespesas ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p><strong>Sobra:</strong> <span class="text-green-600">${(acerto.sobra ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></p>
                    `;
                    if (acerto.driverSignatureImage) {
                        details += `<p class="mt-4"><strong>Assinatura do Motorista:</strong></p><img src="${acerto.driverSignatureImage}" alt="Assinatura Motorista" style="max-width: 100%; height: auto; border: 1px solid #ccc;">`;
                    } else {
                        details += `<p class="mt-4"><strong>Assinatura do Motorista:</strong> N/A</p>`;
                    }
                    if (acerto.ownerSignatureImage) {
                        details += `<p class="mt-4"><strong>Assinatura do Proprietário:</strong></p><img src="${acerto.ownerSignatureImage}" alt="Assinatura Proprietário" style="max-width: 100%; height: auto; border: 1px solid #ccc;">`;
                    } else {
                        details += `<p class="mt-4"><strong>Assinatura do Proprietário:</strong> N/A</p>`;
                    }
                    showModal(details);
                } else {
                    showModal("Acerto não encontrado.");
                }
            } catch (error) {
                    console.error("DEBUG: Error viewing settlement details: ", error.message, error);
                    showModal("Erro ao ver detalhes do acerto.");
            }
        }

        /**
         * Abre o modal de assinatura e carrega as assinaturas existentes para o acerto.
         * @param {string} acertoId - O ID do acerto para o qual as assinaturas serão feitas/visualizadas.
         */
        async function openSignatureModal(acertoId) {
            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            currentAcertoIdForSignature = acertoId;

            clearSignatureCanvas(modalDriverSignatureCtx, modalDriverSignatureCanvas);
            clearSignatureCanvas(modalOwnerSignatureCtx, modalOwnerSignatureCanvas);

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/acertos`, acertoId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const acerto = docSnap.data();
                    if (acerto.driverSignatureImage) {
                        const img = new Image();
                        img.onload = () => {
                            modalDriverSignatureCtx.drawImage(img, 0, 0, modalDriverSignatureCanvas.width, modalDriverSignatureCanvas.height);
                        };
                        img.src = acerto.driverSignatureImage;
                    }
                    if (acerto.ownerSignatureImage) {
                        const img = new Image();
                        img.onload = () => {
                            modalOwnerSignatureCtx.drawImage(img, 0, 0, modalOwnerSignatureCanvas.width, modalOwnerSignatureCanvas.height);
                        };
                        img.src = acerto.ownerSignatureImage;
                    }
                } else {
                    console.warn("DEBUG: Settlement not found when opening signature modal:", acertoId);
                }
                signatureModal.style.display = 'flex';
            } catch (error) {
                console.error("DEBUG: Error opening signature modal:", error.message, error);
                showModal("Erro ao carregar assinaturas. Tente novamente.");
            }
        }

        // Listener para o botão "Salvar Assinaturas e Gerar Recibo" dentro do modal
        saveAndGenerateReciboButton.addEventListener('click', async () => {
            if (!currentAcertoIdForSignature) {
                showModal("Nenhum acerto selecionado para salvar assinaturas.");
                return;
            }

            try {
                const driverSignatureImage = modalDriverSignatureCanvas.toDataURL('image/png');
                const ownerSignatureImage = modalOwnerSignatureCanvas.toDataURL('image/png');

                const isDriverSignatureBlank = driverSignatureImage === clearSignatureCanvas(modalDriverSignatureCtx, modalDriverSignatureCanvas, true);
                const isOwnerSignatureBlank = ownerSignatureImage === clearSignatureCanvas(modalOwnerSignatureCtx, modalOwnerSignatureCanvas, true);

                const acertoDocRef = doc(db, `artifacts/${appId}/public/data/acertos`, currentAcertoIdForSignature);
                await updateDoc(acertoDocRef, {
                    driverSignatureImage: isDriverSignatureBlank ? '' : driverSignatureImage,
                    ownerSignatureImage: isOwnerSignatureBlank ? '' : ownerSignatureImage
                });

                console.log("DEBUG: Signatures saved/updated for settlement:", currentAcertoIdForSignature);
                signatureModal.style.display = 'none';
                await generateReciboPDF(currentAcertoIdForSignature);
            } catch (error) {
                console.error("DEBUG: Error saving signatures and generating receipt:", error.message, error);
                showModal("Erro ao salvar assinaturas e gerar recibo. Tente novamente.");
            }
        });

        // Listener para o botão "Cancelar" no modal de assinatura
        cancelSignatureButton.addEventListener('click', () => {
            signatureModal.style.display = 'none';
            currentAcertoIdForSignature = null;
        });

        // Listener para o botão de fechar (X) no modal de assinatura
        closeSignatureModalButton.addEventListener('click', () => {
            signatureModal.style.display = 'none';
            currentAcertoIdForSignature = null;
        });

        /**
         * Gera um recibo PDF para um acerto específico, contendo apenas o valor da comissão.
         * @param {string} id - O ID do documento de acerto.
         */
        async function generateReciboPDF(id) {
            if (!isAuthReady) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/acertos`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const acerto = docSnap.data();
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    let y = 10;
                    const lineHeight = 7;
                    const margin = 10;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const imgWidth = 80;
                    const imgHeight = (modalDriverSignatureCanvas.height / modalDriverSignatureCanvas.width) * imgWidth;
                    
                    doc.setFontSize(16);
                    doc.text("Recibo de Acerto de Viagem", pageWidth / 2, y, { align: "center" });
                    y += lineHeight * 2;

                    doc.setFontSize(12);
                    doc.text(`Empresa: ${companyNameSpan.textContent}`, margin, y);
                    y += lineHeight;
                    doc.text(`Data: ${formatDateToDDMMYYYY(acerto.data)}`, margin, y);
                    y += lineHeight;
                    doc.text(`Motorista: ${acerto.motorista}`, margin, y);
                    y += lineHeight;
                    doc.text(`Caminhão: ${acerto.caminhao}`, margin, y);
                    y += lineHeight;
                    doc.text(`Valor da Comissão: ${(acerto.comissao ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                    y += lineHeight * 4;

                    if (acerto.driverSignatureImage) {
                        doc.text("Assinatura do Motorista:", pageWidth / 2, y, { align: "center" }); // Centraliza o texto
                        y += lineHeight;
                        const driverImgX = (pageWidth - imgWidth) / 2;
                        doc.addImage(acerto.driverSignatureImage, 'PNG', driverImgX, y, imgWidth, imgHeight);
                        y += imgHeight + 3;
                        doc.text("___________________________", pageWidth / 2, y, { align: "center" });
                        y += lineHeight;
                        doc.text("Motorista", pageWidth / 2, y, { align: "center" });
                        y += lineHeight * 2;
                    } else {
                        doc.text("Assinatura do Motorista: N/A", pageWidth / 2, y, { align: "center" }); // Centraliza o texto
                        y += lineHeight * 3;
                    }

                    if (acerto.ownerSignatureImage) {
                        doc.text("Assinatura do Proprietário:", pageWidth / 2, y, { align: "center" }); // Centraliza o texto
                        y += lineHeight;
                        const ownerImgX = (pageWidth - imgWidth) / 2;
                        doc.addImage(acerto.ownerSignatureImage, 'PNG', ownerImgX, y, imgWidth, imgHeight);
                        y += imgHeight + 3;
                        doc.text("___________________________", pageWidth / 2, y, { align: "center" });
                        y += lineHeight;
                        doc.text("Proprietário", pageWidth / 2, y, { align: "center" });
                    } else {
                        doc.text("Assinatura do Proprietário: N/A", pageWidth / 2, y, { align: "center" }); // Centraliza o texto
                    }

                    doc.save(`recibo_acerto_${acerto.data}_${acerto.motorista}.pdf`);
                    showModal("Recibo PDF gerado com sucesso!");

                } else {
                    showModal("Acerto não encontrado para gerar recibo.");
                }
            } catch (error) {
                console.error("DEBUG: Error generating PDF receipt: ", error.message, error);
                showModal("Erro ao gerar recibo PDF. Tente novamente.");
            }
        };


        // --- Lógica da Aba de Caixa (Fluxo de Caixa) ---
        caixaIsBoletoCheckbox.addEventListener('change', () => {
            if (caixaTipoSelect.value === 'saida' && caixaIsBoletoCheckbox.checked) {
                vencimentoField.classList.remove('hidden');
            } else {
                vencimentoField.classList.add('hidden');
                caixaDiasVencimentoInput.value = '';
            }
            if (caixaIsBoletoCheckbox.checked) {
                caixaIsChequeCheckbox.checked = false;
                apresentacaoChequeField.classList.add('hidden');
                caixaDiasApresentacaoChequeInput.value = '';
            }
        });

        caixaIsChequeCheckbox.addEventListener('change', () => {
            if (caixaIsChequeCheckbox.checked) {
                apresentacaoChequeField.classList.remove('hidden');
            } else {
                apresentacaoChequeField.classList.add('hidden');
                caixaDiasApresentacaoChequeInput.value = '';
            }
            if (caixaIsChequeCheckbox.checked) {
                caixaIsBoletoCheckbox.checked = false;
                vencimentoField.classList.add('hidden');
                caixaDiasVencimentoInput.value = '';
            }
        });

        caixaTipoSelect.addEventListener('change', () => {
            if (caixaTipoSelect.value === 'saida' && caixaIsBoletoCheckbox.checked) {
                vencimentoField.classList.remove('hidden');
            } else {
                vencimentoField.classList.add('hidden');
                caixaDiasVencimentoInput.value = '';
            }
            if (caixaTipoSelect.value === 'saida' && caixaIsChequeCheckbox.checked) {
                apresentacaoChequeField.classList.remove('hidden');
            } else {
                apresentacaoChequeField.classList.add('hidden');
                caixaDiasApresentacaoChequeInput.value = '';
            }
        });

        /**
         * Limpa todos os campos do formulário de caixa.
         */
        function clearCaixaForm() {
            caixaTipoSelect.value = 'saida'; // Default to 'saida'
            caixaValorInput.value = '';
            caixaCategoriaInput.value = '';
            caixaDataInput.value = '';
            caixaDiasVencimentoInput.value = '';
            caixaDiasApresentacaoChequeInput.value = '';
            caixaNumParcelasInput.value = '1';
            caixaIntervaloParcelasInput.value = ''; // Intervalo entre parcelas em branco por padrão
            caixaDescricaoTextarea.value = '';
            caixaObservacoesTextarea.value = '';
            caixaIsBoletoCheckbox.checked = false;
            caixaIsChequeCheckbox.checked = false;
            vencimentoField.classList.add('hidden'); // Escondido por padrão, só aparece se for boleto/saída
            apresentacaoChequeField.classList.add('hidden');
            if (saveCaixaButton) {
                saveCaixaButton.textContent = 'Salvar Lançamento';
                const icon = saveCaixaButton.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-sync-alt');
                    icon.classList.add('fa-save');
                }
                delete saveCaixaButton.dataset.editId;
            }
        }

        clearCaixaButton.addEventListener('click', clearCaixaForm);

        // Listener para o envio do formulário de caixa
        caixaForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            const tipo = caixaTipoSelect.value;
            const valorTotal = parseFloat(caixaValorInput.value.replace(/\D/g, '')) / 100 || 0;
            const categoria = caixaCategoriaInput.value.trim();
            const dataLancamento = caixaDataInput.value;
            const descricaoBase = caixaDescricaoTextarea.value.trim();
            const observacoes = caixaObservacoesTextarea.value.trim();
            const isBoleto = caixaIsBoletoCheckbox.checked;
            const isCheque = caixaIsChequeCheckbox.checked;
            const diasVencimento = parseInt(caixaDiasVencimentoInput.value, 10) || 0;
            const diasApresentacaoCheque = parseInt(caixaDiasApresentacaoChequeInput.value, 10) || 0;
            const numParcelas = parseInt(caixaNumParcelasInput.value, 10) || 1;
            const intervaloParcelasText = caixaIntervaloParcelasInput.value.trim().toLowerCase();

            if (!valorTotal || valorTotal <= 0 || !categoria || !dataLancamento) {
                showModal("Por favor, preencha os campos obrigatórios: Valor, Categoria e Data.");
                return;
            }
            if (isBoleto && diasVencimento < 0) {
                showModal("Por favor, informe um número válido de dias para vencimento do boleto.");
                return;
            }
            if (isCheque && diasApresentacaoCheque < 0) {
                showModal("Por favor, informe um número válido de dias para apresentação do cheque.");
                return;
            }
            if (numParcelas < 1) {
                showModal("O número de parcelas deve ser no mínimo 1.");
                return;
            }

            const editId = saveCaixaButton.dataset.editId;
            const caixaCollectionRef = collection(db, `artifacts/${appId}/public/data/caixa`);

            try {
                if (editId) {
                    console.log(`DEBUG: Starting update of caixa entry with ID: ${editId}`);
                    const docRef = doc(db, `artifacts/${appId}/public/data/caixa`, editId);
                    const existingDoc = await getDoc(docRef);

                    if (existingDoc.exists()) {
                        const realVencimento = isBoleto ? addDaysToDate(dataLancamento, diasVencimento) : '';
                        const realApresentacaoCheque = isCheque ? addDaysToDate(dataLancamento, diasApresentacaoCheque) : '';

                        const caixaEntry = {
                            tipo: tipo,
                            valor: valorTotal,
                            categoria: categoria,
                            data: dataLancamento,
                            descricao: descricaoBase,
                            observacoes: observacoes,
                            vencimento: realVencimento,
                            isBoleto: isBoleto,
                            isCheque: isCheque,
                            apresentacaoCheque: realApresentacaoCheque,
                            pago: (tipo === 'entrada') ? true : (existingDoc.data().pago ?? false),
                            timestamp: new Date(),
                            numParcelas: 1, // When editing, it's always a single entry
                            parcelaAtual: 1
                        };
                        console.log("DEBUG: Payload for Firestore (caixa update - single entry):", caixaEntry);
                        await updateDoc(docRef, caixaEntry);
                        showModal("Lançamento atualizado com sucesso!");
                    }
                } else {
                    const valorPorParcela = valorTotal / numParcelas;
                    const promises = [];

                    let currentVencimentoDate = isBoleto ? new Date(dataLancamento + 'T00:00:00') : null;
                    let currentApresentacaoChequeDate = isCheque ? new Date(dataLancamento + 'T00:00:00') : null;

                    if (isBoleto && currentVencimentoDate) {
                        currentVencimentoDate.setDate(currentVencimentoDate.getDate() + diasVencimento);
                    }
                    if (isCheque && currentApresentacaoChequeDate) {
                        currentApresentacaoChequeDate.setDate(currentApresentacaoChequeDate.getDate() + diasApresentacaoCheque);
                    }

                    for (let i = 0; i < numParcelas; i++) {
                        // Calculate data for current parcel
                        const dataParcela = new Date(dataLancamento + 'T00:00:00');
                        // No need to add interval to dataParcela, as it's the date of the transaction, not the due date
                        const formattedDataParcela = dataParcela.toISOString().split('T')[0];

                        let formattedParcelaVencimento = '';
                        if (isBoleto && currentVencimentoDate) {
                            formattedParcelaVencimento = currentVencimentoDate.toISOString().split('T')[0];
                        }

                        let formattedParcelaApresentacaoCheque = '';
                        if (isCheque && currentApresentacaoChequeDate) {
                            formattedParcelaApresentacaoCheque = currentApresentacaoChequeDate.toISOString().split('T')[0];
                        }

                        const descricaoParcela = numParcelas > 1 ? `${descricaoBase} (Parcela ${i + 1}/${numParcelas})` : descricaoBase;

                        const caixaEntry = {
                            tipo: tipo,
                            valor: valorPorParcela,
                            categoria: categoria,
                            data: formattedDataParcela,
                            descricao: descricaoParcela,
                            observacoes: observacoes,
                            vencimento: formattedParcelaVencimento,
                            apresentacaoCheque: formattedParcelaApresentacaoCheque,
                            isBoleto: isBoleto,
                            isCheque: isCheque,
                            pago: (tipo === 'entrada') ? true : false,
                            timestamp: new Date(),
                            numParcelas: numParcelas,
                            parcelaAtual: i + 1
                        };
                        console.log(`DEBUG: Payload for Firestore (new caixa entry - parcel ${i + 1}):`, caixaEntry);
                        promises.push(addDoc(caixaCollectionRef, caixaEntry));

                        // Calculate next vencimento/apresentacao date for next parcel
                        if (i < numParcelas - 1) {
                            if (intervaloParcelasText === '') {
                                // Default to monthly, keeping the day
                                if (currentVencimentoDate) {
                                    const originalDay = currentVencimentoDate.getDate();
                                    currentVencimentoDate.setMonth(currentVencimentoDate.getMonth() + 1);
                                    if (currentVencimentoDate.getDate() !== originalDay) {
                                        currentVencimentoDate.setDate(0); // Go to last day of previous month
                                    }
                                }
                                if (currentApresentacaoChequeDate) {
                                    const originalDay = currentApresentacaoChequeDate.getDate();
                                    currentApresentacaoChequeDate.setMonth(currentApresentacaoChequeDate.getMonth() + 1);
                                    if (currentApresentacaoChequeDate.getDate() !== originalDay) {
                                        currentApresentacaoChequeDate.setDate(0); // Go to last day of previous month
                                    }
                                }
                            } else if (intervaloParcelasText.includes('dias')) {
                                const days = parseInt(intervaloParcelasText.replace('dias', '').trim());
                                if (!isNaN(days)) {
                                    if (currentVencimentoDate) currentVencimentoDate.setDate(currentVencimentoDate.getDate() + days);
                                    if (currentApresentacaoChequeDate) currentApresentacaoChequeDate.setDate(currentApresentacaoChequeDate.getDate() + days);
                                } else {
                                    showModal("Intervalo de dias inválido. Use 'X dias' ou deixe em branco para mensal.");
                                    return;
                                }
                            } else if (intervaloParcelasText.includes('mês') || intervaloParcelasText.includes('meses')) {
                                const months = parseInt(intervaloParcelasText.replace('mês', '').replace('meses', '').trim());
                                if (!isNaN(months)) {
                                    if (currentVencimentoDate) {
                                        const originalDay = currentVencimentoDate.getDate();
                                        currentVencimentoDate.setMonth(currentVencimentoDate.getMonth() + months);
                                        if (currentVencimentoDate.getDate() !== originalDay) {
                                            currentVencimentoDate.setDate(0);
                                        }
                                    }
                                    if (currentApresentacaoChequeDate) {
                                        const originalDay = currentApresentacaoChequeDate.getDate();
                                        currentApresentacaoChequeDate.setMonth(currentApresentacaoChequeDate.getMonth() + months);
                                        if (currentApresentacaoChequeDate.getDate() !== originalDay) {
                                            currentApresentacaoChequeDate.setDate(0);
                                        }
                                    }
                                } else {
                                    showModal("Intervalo de meses inválido. Use 'X mês'/'X meses' ou deixe em branco para mensal.");
                                    return;
                                }
                            } else {
                                // Fallback if interval format is completely unexpected, assume monthly
                                console.warn("DEBUG: Unexpected interval format, defaulting to monthly.");
                                if (currentVencimentoDate) {
                                    const originalDay = currentVencimentoDate.getDate();
                                    currentVencimentoDate.setMonth(currentVencimentoDate.getMonth() + 1);
                                    if (currentVencimentoDate.getDate() !== originalDay) {
                                        currentVencimentoDate.setDate(0);
                                    }
                                }
                                if (currentApresentacaoChequeDate) {
                                    const originalDay = currentApresentacaoChequeDate.getDate();
                                    currentApresentacaoChequeDate.setMonth(currentApresentacaoChequeDate.getMonth() + 1);
                                    if (currentApresentacaoChequeDate.getDate() !== originalDay) {
                                        currentApresentacaoChequeDate.setDate(0);
                                    }
                                }
                            }
                        }
                    }
                    await Promise.all(promises);
                    console.log("DEBUG: New caixa entries saved in Firestore.");
                    showModal("Lançamento(s) salvo(s) com sucesso!");
                }
                clearCaixaForm();
            }
            catch (e) {
                console.error("DEBUG: Error saving/updating caixa entry: ", e.message, e);
                showModal("Erro ao salvar/atualizar lançamento do caixa. Tente novamente.");
            }
        });

        /**
         * Configura o listener em tempo real para a coleção de caixa no Firestore.
         * Atualiza a tabela de caixa, os totalizadores e o alerta de boletos vencendo.
         */
        function setupCaixaListener() {
            if (unsubscribeCaixa) unsubscribeCaixa();

            if (!isAuthReady) {
                console.warn("DEBUG: Sistema de autenticação não pronto para o listener de caixa. Pulando a configuração.");
                return;
            }
            console.log("DEBUG: Setting up Caixa listener for fixed user:", FIXED_USER_ID);

            const caixaCollectionRef = collection(db, `artifacts/${appId}/public/data/caixa`);
            let q = query(caixaCollectionRef);

            unsubscribeCaixa = onSnapshot(q, (snapshot) => {
                allCaixaData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("DEBUG: Raw Caixa Entry from Firestore:", data);
                    allCaixaData.push({ id: doc.id, ...data });
                });
                console.log("DEBUG: All caixa entries loaded successfully:", allCaixaData.length, "entries.");
                const filteredCaixa = getFilteredCaixaEntries(allCaixaData);
                renderCaixaTable(filteredCaixa);
                calculateCaixaTotals(filteredCaixa);
                checkBoletosVencendoHoje(allCaixaData);
            }, (error) => {
                console.error("DEBUG: Error loading caixa entries:", error);
                showModal("Erro ao carregar lançamentos do caixa. Por favor, verifique o console para mais detalhes.");
            });
        }

        /**
         * Retorna uma lista de entradas de caixa filtradas com base nas entradas de filtro atuais.
         * @param {Array<Object>} caixaEntries - A lista completa de entradas de caixa.
         * @returns {Array<Object>} A lista de entradas de caixa filtradas.
         */
        function getFilteredCaixaEntries(caixaEntries) {
            const sortedCaixaEntries = [...caixaEntries].sort((a, b) => {
                const dateA = new Date(a.data + "T00:00:00");
                const dateB = new Date(b.data + "T00:00:00");
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateB - dateA;
                }
                if (a.tipo === 'entrada' && b.tipo === 'saida') return -1;
                if (a.tipo === 'saida' && b.tipo === 'entrada') return 1;
                return (a.parcelaAtual || 1) - (b.parcelaAtual || 1);
            });

            const filterType = filterCaixaTipoSelect.value;
            const filterStartDate = filterCaixaDataInicialInput.value ? new Date(filterCaixaDataInicialInput.value + "T00:00:00") : null;
            const filterEndDate = filterCaixaDataFinalInput.value ? new Date(filterCaixaDataFinalInput.value + "T00:00:00") : null;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const filteredCaixa = sortedCaixaEntries.filter(entry => {
                let matchesFilter = true;

                if (filterType !== 'ambos') {
                    if (filterType === 'boletos-vencendo') {
                        if (!(entry.tipo === 'saida' && entry.vencimento && entry.isBoleto === true && entry.pago !== true)) {
                            matchesFilter = false;
                        } else {
                            const vencimentoDate = new Date(entry.vencimento + "T00:00:00");
                            if (isNaN(vencimentoDate.getTime())) {
                                console.warn(`DEBUG: Invalid vencimento date for filtering (ID: ${entry.id || 'N/A'}): '${entry.vencimento}'`);
                                matchesFilter = false;
                            } else {
                                vencimentoDate.setHours(0, 0, 0, 0);
                                if (vencimentoDate.getTime() !== today.getTime()) {
                                    matchesFilter = false;
                                }
                            }
                        }
                    } else if (filterType === 'somente-boleto') {
                        if (!(entry.isBoleto === true && entry.tipo === 'saida')) {
                            matchesFilter = false;
                        }
                    } else if (filterType === 'somente-cheque') {
                        if (!(entry.isCheque === true && entry.tipo === 'saida')) {
                            matchesFilter = false;
                        }
                    } else if (entry.tipo !== filterType) {
                        matchesFilter = false;
                    }
                }

                if (filterType !== 'boletos-vencendo') {
                    const entryDate = new Date(entry.data + "T00:00:00");
                    entryDate.setHours(0,0,0,0);
                    if (filterStartDate && entryDate < filterStartDate) matchesFilter = false;
                    if (filterEndDate && entryDate > filterEndDate) matchesFilter = false;
                }
                
                return matchesFilter;
            });
            return filteredCaixa;
        }

        /**
         * Renderiza a tabela de entradas de caixa com base nos dados fornecidos.
         * @param {Array<Object>} caixaEntriesToRender - Uma lista de objetos de entrada de caixa já filtrados.
         */
        function renderCaixaTable(caixaEntriesToRender) {
            caixaTableBody.innerHTML = '';

            if (caixaEntriesToRender.length === 0) {
                caixaTableBody.innerHTML = `<tr><td colspan="8" class="py-3 px-6 text-center">Nenhum lançamento encontrado.</td></tr>`;
                return;
            }

            caixaEntriesToRender.forEach(entry => {
                const row = caixaTableBody.insertRow();
                const isPaid = entry.pago === true;
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                if (isPaid && entry.tipo === 'saida') {
                    row.classList.add('paid-entry');
                }

                const valorClass = entry.tipo === 'entrada' ? 'text-green-600' : 'text-blue-600';
                
                let statusText;
                let actionButtons = '';

                if (entry.tipo === 'entrada') {
                    statusText = isPaid ? '<span class="text-green-500"><i class="fas fa-check-circle"></i> Recebido</span>' : '<span class="text-red-500"><i class="fas fa-times-circle"></i> Pendente</span>';
                } else {
                    statusText = isPaid ? '<span class="text-green-500"><i class="fas fa-check-circle"></i> Pago</span>' : '<span class="text-red-500"><i class="fas fa-times-circle"></i> Não Pago</span>';
                    if (!isPaid) {
                        actionButtons += `<button class="mark-paid-button bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded-lg text-xs ml-2" data-id="${entry.id}" title="Marcar como Pago"><i class="fas fa-check"></i> Pago</button>`;
                    }
                }

                const vencimentoOuApresentacao = entry.isBoleto ? formatDateToDDMMYYYY(entry.vencimento) : (entry.isCheque ? formatDateToDDMMYYYY(entry.apresentacaoCheque) : 'N/A');

                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${entry.tipo === 'entrada' ? 'Entrada' : 'Saída'}</td>
                    <td class="py-3 px-6 text-left ${valorClass}">${(entry.valor ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="py-3 px-6 text-left">${entry.categoria}</td>
                    <td class="py-3 px-6 text-left">${formatDateToDDMMYYYY(entry.data)}</td>
                    <td class="py-3 px-6 text-left">${vencimentoOuApresentacao}</td>
                    <td class="py-3 px-6 text-left">${entry.descricao || 'N/A'}</td>
                    <td class="py-3 px-6 text-center">${statusText}</td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <button class="edit-caixa-button text-blue-500 hover:text-blue-700 mr-2" data-id="${entry.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-caixa-button text-red-500 hover:text-red-700" data-id="${entry.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                        ${actionButtons}
                    </td>
                `;
            });

            document.querySelectorAll('.edit-caixa-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await editCaixaEntry(id);
                });
            });
            document.querySelectorAll('.delete-caixa-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const confirmed = await showModal("Tem certeza que deseja excluir este lançamento?", 'confirm');
                    if (confirmed) {
                        await deleteCaixaEntry(id);
                    }
                });
            });
            document.querySelectorAll('.mark-paid-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const confirmed = await showModal("Marcar este boleto como pago?", 'confirm');
                    if (confirmed) {
                        await markCaixaAsPaid(id);
                    }
                });
            });
        }

        /**
         * Calcula e exibe os totais de entradas, saídas e o saldo atual do caixa, com base nas entradas fornecidas.
         * @param {Array<Object>} caixaEntriesToCalculate - Uma lista de objetos de entrada de caixa já filtrados.
         */
        function calculateCaixaTotals(caixaEntriesToCalculate) {
            let totalEntradas = 0;
            let totalSaidas = 0;

            caixaEntriesToCalculate.forEach(entry => {
                if (entry.tipo === 'entrada') {
                    totalEntradas += entry.valor || 0;
                } else {
                    totalSaidas += entry.valor || 0;
                }
            });

            totalEntradasSpan.textContent = totalEntradas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            totalSaidasSpan.textContent = totalSaidas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            const saldoAtual = totalEntradas - totalSaidas;
            totalSaldoSpan.textContent = formatNegativeCurrency(saldoAtual); // Use custom formatter
            totalSaldoSpan.classList.remove('text-green-600', 'text-red-600');
            if (saldoAtual >= 0) {
                totalSaldoSpan.classList.add('text-green-600');
            } else {
                totalSaldoSpan.classList.add('text-red-600');
            }
        }

        filterCaixaButton.addEventListener('click', () => {
            if (isAuthReady) {
                const filteredCaixa = getFilteredCaixaEntries(allCaixaData);
                renderCaixaTable(filteredCaixa);
                calculateCaixaTotals(filteredCaixa);
            }
        });
        filterCaixaTipoSelect.addEventListener('change', () => {
            if (isAuthReady) {
                const filteredCaixa = getFilteredCaixaEntries(allCaixaData);
                renderCaixaTable(filteredCaixa);
                calculateCaixaTotals(filteredCaixa);
            }
        });


        /**
         * Gera um relatório PDF das entradas de caixa com base nos filtros aplicados.
         */
        generateAcertoReportButton.addEventListener('click', async () => {
            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            try {
                const filteredAcertos = getFilteredAcertos(allAcertosData);

                console.log("DEBUG: Settlements found for the report:", filteredAcertos.length, filteredAcertos);

                if (filteredAcertos.length === 0) {
                    showModal("Nenhum acerto encontrado para gerar o relatório com os filtros aplicados.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let y = 10;
                const lineHeight = 7;
                const margin = 10;
                const pageWidth = doc.internal.pageSize.getWidth();

                doc.setFontSize(16);
                doc.text("Relatório de Acertos de Viagem", pageWidth / 2, y, { align: "center" });
                y += lineHeight * 2;

                doc.setFontSize(12);
                doc.text(`Empresa: ${companyNameSpan.textContent}`, margin, y);
                y += lineHeight;
                doc.text(`Período: ${formatDateToDDMMYYYY(filterAcertoDataInicialInput.value) || 'Início'} a ${formatDateToDDMMYYYY(filterAcertoDataFinalInput.value) || 'Fim'}`, margin, y);
                y += lineHeight * 2;

                let totalFreteReport = 0;
                let totalComissaoReport = 0;
                let totalDespesasReport = 0;
                let totalSobraReport = 0;

                filteredAcertos.forEach(acerto => {
                    totalFreteReport += acerto.frete || 0;
                    totalComissaoReport += acerto.comissao || 0;
                    totalDespesasReport += acerto.totalDespesas || 0;
                    totalSobraReport += acerto.sobra || 0;
                });

                doc.text(`Total Frete: ${totalFreteReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight;
                doc.text(`Total Comissão: ${totalComissaoReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight;
                doc.text(`Total Despesas: ${totalDespesasReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight;
                doc.text(`Total Sobra: ${totalSobraReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight * 2;

                const headers = [
                    "Data", "Motorista", "Caminhão", "Frete", "Comissão", "Sobra"
                ];
                const dataForTable = filteredAcertos.map(acerto => [
                    formatDateToDDMMYYYY(acerto.data),
                    acerto.motorista,
                    acerto.caminhao,
                    (acerto.frete ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    (acerto.comissao ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                    (acerto.sobra ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                ]);
                console.log("DEBUG: Data for settlement report table:", dataForTable);


                doc.autoTable({
                    startY: y,
                    head: [headers],
                    body: dataForTable,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                    headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0] },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.text(str, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - margin);
                    }
                });

                doc.save(`relatorio_acertos_${filterAcertoDataInicialInput.value || 'todos'}_${filterAcertoDataFinalInput.value || 'todos'}.pdf`);
                showModal("Relatório de Acertos PDF gerado com sucesso!");

            } catch (error) {
                console.error("DEBUG: Error generating settlement report PDF: ", error.message, error);
                showModal("Erro ao gerar relatório de acertos PDF. Tente novamente.");
            }
        });

        /**
         * Carrega os dados de uma entrada de caixa específica no formulário para edição.
         * @param {string} id - O ID do documento da entrada.
         */
        async function editCaixaEntry(id) {
            console.log("DEBUG: Entering editCaixaEntry for ID:", id);
            if (!isAuthReady) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/caixa`, id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal("Lançamento não encontrado.");
                    return;
                }

                const entry = docSnap.data();
                console.log("DEBUG: Caixa entry loaded =>", entry);

                caixaTipoSelect.value = entry.tipo || 'entrada';
                caixaValorInput.value = Number(entry.valor ?? 0).toFixed(2).replace('.', ',');
                caixaCategoriaInput.value = entry.categoria || '';
                caixaDataInput.value = entry.data || '';
                caixaDescricaoTextarea.value = entry.descricao || '';
                caixaObservacoesTextarea.value = entry.observacoes || '';
                caixaIsBoletoCheckbox.checked = entry.isBoleto ?? false;
                caixaIsChequeCheckbox.checked = entry.isCheque ?? false;
                caixaNumParcelasInput.value = entry.numParcelas || 1;
                caixaIntervaloParcelasInput.value = ''; // Always clear interval when editing a single entry

                if (entry.isBoleto && entry.vencimento && entry.data) {
                    const dataLancamento = new Date(entry.data + 'T00:00:00');
                    const dataVencimento = new Date(entry.vencimento + 'T00:00:00');
                    const diffTime = Math.abs(dataVencimento.getTime() - dataLancamento.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    caixaDiasVencimentoInput.value = diffDays;
                    vencimentoField.classList.remove('hidden');
                } else {
                    caixaDiasVencimentoInput.value = '';
                    vencimentoField.classList.add('hidden');
                }

                if (entry.isCheque && entry.apresentacaoCheque && entry.data) {
                    const dataLancamento = new Date(entry.data + 'T00:00:00');
                    const dataApresentacao = new Date(entry.apresentacaoCheque + 'T00:00:00');
                    const diffTime = Math.abs(dataApresentacao.getTime() - dataLancamento.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    caixaDiasApresentacaoChequeInput.value = diffDays;
                    apresentacaoChequeField.classList.remove('hidden');
                } else {
                    caixaDiasApresentacaoChequeInput.value = '';
                    apresentacaoChequeField.classList.add('hidden');
                }

                if (saveCaixaButton) {
                    saveCaixaButton.textContent = 'Atualizar Lançamento';
                    const icon = saveCaixaButton.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-save');
                        icon.classList.add('fa-sync-alt');
                    }
                    saveCaixaButton.dataset.editId = id;
                }

                caixaForm.scrollIntoView({ behavior: 'smooth' });
                showModal("Lançamento carregado para edição.");
            } catch (error) {
                console.error("DEBUG: Error loading entry for editing: ", error.message, error);
                showModal("Erro ao carregar lançamento para edição. Detalhes no console.");
            }
        }

        /**
         * Marca uma entrada de caixa como paga.
         * @param {string} id - O ID do documento da entrada.
         */
        async function markCaixaAsPaid(id) {
            if (!isAuthReady) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/caixa`, id);
                await updateDoc(docRef, {
                    pago: true,
                    dataPagamento: new Date().toISOString().split('T')[0]
                });
                showModal("Lançamento marcado como pago com sucesso!");
            } catch (error) {
                console.error("DEBUG: Error marking entry as paid: ", error.message, error);
                showModal("Erro ao marcar lançamento como pago. Tente novamente.");
            }
        }

        /**
         * Exclui uma entrada de caixa.
         * @param {string} id - O ID do documento da entrada.
         */
        async function deleteCaixaEntry(id) {
            if (!isAuthReady) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/caixa`, id);
                await deleteDoc(docRef);
                showModal("Lançamento excluído com sucesso!");
            } catch (error) {
                console.error("DEBUG: Error deleting entry: ", error.message, error);
                showModal("Erro ao excluir lançamento.");
            }
        }

        /**
         * Gera um relatório PDF das entradas de caixa com base nos filtros aplicados.
         */
        async function generateCaixaReportPDF() {
            console.log("DEBUG: generateCaixaReportPDF called.");
            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            try {
                const filteredCaixa = getFilteredCaixaEntries(allCaixaData);

                console.log("DEBUG: Caixa entries found for the report:", filteredCaixa.length, filteredCaixa);

                if (filteredCaixa.length === 0) {
                    showModal("Nenhum lançamento de caixa encontrado para gerar o relatório com os filtros aplicados.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let y = 10;
                const lineHeight = 7;
                const margin = 10;
                const pageWidth = doc.internal.pageSize.getWidth();


                doc.setFontSize(16);
                doc.text("Relatório de Entradas e Saídas (Caixa)", pageWidth / 2, y, { align: "center" });
                y += lineHeight * 2;

                doc.setFontSize(12);
                doc.text(`Empresa: ${companyNameSpan.textContent}`, margin, y);
                y += lineHeight;
                doc.text(`Período: ${formatDateToDDMMYYYY(filterCaixaDataInicialInput.value) || 'Início'} a ${formatDateToDDMMYYYY(filterCaixaDataFinalInput.value) || 'Fim'}`, margin, y);
                y += lineHeight;
                doc.text(`Tipo: ${filterCaixaTipoSelect.value === 'ambos' ? 'Ambos' : (filterCaixaTipoSelect.value === 'entrada' ? 'Entradas' : filterCaixaTipoSelect.value === 'saida' ? 'Saídas' : (filterCaixaTipoSelect.value === 'somente-boleto' ? 'Somente Boletos' : filterCaixaTipoSelect.value === 'somente-cheque' ? 'Somente Cheques' : 'Boletos Vencendo Hoje'))}`, margin, y);
                y += lineHeight * 2;

                let totalEntradasReport = 0;
                let totalSaidasReport = 0;

                filteredCaixa.forEach(entry => {
                    if (entry.tipo === 'entrada') {
                        totalEntradasReport += entry.valor || 0;
                    } else {
                        totalSaidasReport += entry.valor || 0;
                    }
                });

                doc.text(`Total Entradas: ${totalEntradasReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight;
                doc.text(`Total Saídas: ${totalSaidasReport.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight;
                doc.text(`Saldo Atual: ${(totalEntradasReport - totalSaidasReport).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, margin, y);
                y += lineHeight * 2;

                const headers = [
                    "Tipo", "Valor", "Categoria", "Data", "Vencimento / Apresentação", "Descrição", "Status"
                ];
                const dataForTable = filteredCaixa.map(entry => {
                    let statusForReport;
                    if (entry.tipo === 'entrada') {
                        statusForReport = entry.pago ? 'Recebido' : 'Pendente';
                    } else {
                        statusForReport = entry.pago ? 'Pago' : 'Não Pago';
                    }
                    const vencimentoOuApresentacaoReport = entry.isBoleto ? formatDateToDDMMYYYY(entry.vencimento) : (entry.isCheque ? formatDateToDDMMYYYY(entry.apresentacaoCheque) : 'N/A');

                    return [
                        entry.tipo === 'entrada' ? 'Entrada' : 'Saída',
                        (entry.valor ?? 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
                        entry.categoria,
                        formatDateToDDMMYYYY(entry.data),
                        vencimentoOuApresentacaoReport,
                        entry.descricao || 'N/A',
                        statusForReport
                    ];
                });
                console.log("DEBUG: Data for caixa report table:", dataForTable);

                doc.autoTable({
                    startY: y,
                    head: [headers],
                    body: dataForTable,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak' },
                    headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0] },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.text(str, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - margin);
                    }
                });

                doc.save(`relatorio_caixa_${filterCaixaDataInicialInput.value || 'todos'}_${filterCaixaDataFinalInput.value || 'todos'}.pdf`);
                showModal("Relatório de Caixa PDF gerado com sucesso!");

            } catch (error) {
                console.error("DEBUG: Error generating caixa report PDF: ", error.message, error);
                showModal("Erro ao gerar relatório de caixa PDF. Tente novamente.");
            }
        }

        generateCaixaReportButton.addEventListener('click', generateCaixaReportPDF);

        // --- Alerta de Boleto Vencendo ---
        /**
         * Verifica se há boletos vencendo hoje e exibe um alerta fixo na tela.
         * @param {Array<Object>} caixaEntries - Uma lista de objetos de entrada de caixa.
         */
        function checkBoletosVencendoHoje(caixaEntries) {
            console.log("DEBUG: checkBoletosVencendoHoje called with", caixaEntries.length, "entries.");
            if (!Array.isArray(caixaEntries)) {
                console.warn("DEBUG: checkBoletosVencendoHoje received invalid data. Expected an array.");
                boletoAlertFixed.style.display = 'none';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            console.log("DEBUG: Today (normalized):", today.toISOString().split('T')[0]);

            const boletosVencendo = caixaEntries.filter(entry => {
                console.log(`DEBUG: Processing entry ID: ${entry.id || 'N/A'}, Type: ${entry.tipo}, Is Boleto?: ${entry.isBoleto}, Due Date: '${entry.vencimento}', Paid: ${entry.pago}`);

                if (entry.tipo === 'saida' && (entry.isBoleto === true) && entry.vencimento && (entry.pago !== true)) {
                    const vencimentoDate = new Date(entry.vencimento + "T00:00:00");
                    if (isNaN(vencimentoDate.getTime())) {
                        console.error(`ERROR: Invalid due date for entry ID ${entry.id || 'N/A'}: '${entry.vencimento}'`);
                        return false;
                    }
                    vencimentoDate.setHours(0, 0, 0, 0);
                    const isToday = vencimentoDate.getTime() === today.getTime();
                    console.log(`DEBUG: Boleto: '${entry.descricao || 'No description'}', Normalized Due Date: ${vencimentoDate.toISOString().split('T')[0]}, Is today? ${isToday}, Paid: ${entry.pago}`);
                    return isToday;
                }
                return false;
            });

            if (boletosVencendo.length > 0) {
                let message = '';
                boletosVencendo.forEach((boleto, index) => {
                    message += `"${boleto.descricao || 'Boleto sem descrição'}" (R$ ${(boleto.valor ?? 0).toFixed(2).replace('.', ',')})`;
                    if (index < boletosVencendo.length - 1) {
                        message += '; ';
                    }
                });
                boletoAlertMessageFixed.textContent = message;
                boletoAlertFixed.style.display = 'block';
                console.log("DEBUG: Boleto alert visible:", message);
            } else {
                boletoAlertFixed.style.display = 'none';
                console.log("DEBUG: No boletos expiring today. Alert hidden.");
            }
        }

        // --- Lógica da Aba de Cadastro de Caminhões ---
        /**
         * Limpa os campos do formulário de cadastro de caminhões.
         */
        function clearTruckRegistrationForm() {
            truckNameInput.value = '';
            truckPlateInput.value = '';
            if (saveTruckButton) {
                saveTruckButton.textContent = 'Cadastrar Caminhão';
                const icon = saveTruckButton.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-sync-alt');
                    icon.classList.add('fa-truck-moving');
                }
                delete saveTruckButton.dataset.editId;
            }
        }

        clearTruckButton.addEventListener('click', clearTruckRegistrationForm);

        // Listener para o envio do formulário de cadastro de caminhões
        truckRegistrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady) {
                showModal("Sistema não pronto. Por favor, aguarde ou faça login novamente.");
                return;
            }

            const truckName = truckNameInput.value.trim();
            const plate = truckPlateInput.value.trim().toUpperCase();

            if (!truckName || !plate) {
                showModal("Por favor, preencha o nome do caminhão e a placa do caminhão.");
                return;
            }

            const plateRegex = /^[A-Z]{3}\d{4}$|^[A-Z]{3}\d[A-Z]\d{2}$/;
            if (!plateRegex.test(plate)) {
                showModal("Formato de placa inválido. Use o formato ABC1234 ou ABC1D23.");
                return;
            }

            const truckData = {
                truckName: truckName,
                plate: plate,
                timestamp: new Date()
            };

            const editId = saveTruckButton.dataset.editId;
            const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);

            try {
                if (editId) {
                    console.log(`DEBUG: Starting update of truck with ID: ${editId}`);
                    const docRef = doc(db, `artifacts/${appId}/public/data/trucks`, editId);
                    await updateDoc(docRef, truckData);
                    console.log("DEBUG: Truck updated in Firestore:", editId);
                    showModal("Caminhão atualizado com sucesso!");
                } else {
                    console.log("DEBUG: Starting save of a new truck...");
                    const q = query(trucksCollectionRef, where('plate', '==', plate));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showModal("Já existe um caminhão cadastrado com esta placa.");
                        return;
                    }
                    await addDoc(trucksCollectionRef, truckData);
                    console.log("DEBUG: New truck saved in Firestore.");
                    showModal("Caminhão cadastrado com sucesso!");
                }
                clearTruckRegistrationForm();
            } catch (e) {
                console.error("DEBUG: Error saving/updating truck: ", e.message, e);
                showModal("Erro ao salvar/atualizar caminhão. Tente novamente.");
            }
        });

        /**
         * Configura o listener em tempo real para a coleção de caminhões no Firestore.
         * Atualiza a tabela de caminhões e o select de caminhões nos acertos.
         */
        function setupTrucksListener() {
            if (unsubscribeTrucks) unsubscribeTrucks();

            if (!isAuthReady) {
                console.warn("DEBUG: Sistema de autenticação não pronto para o listener de caminhões. Pulando a configuração.");
                return;
            }
            console.log("DEBUG: Setting up Trucks listener for fixed user:", FIXED_USER_ID);

            const trucksCollectionRef = collection(db, `artifacts/${appId}/public/data/trucks`);
            const q = query(trucksCollectionRef);

            unsubscribeTrucks = onSnapshot(q, (snapshot) => {
                allTrucks = [];
                snapshot.forEach(doc => {
                    allTrucks.push({ id: doc.id, ...doc.data() });
                });
                console.log("DEBUG: Trucks loaded successfully:", allTrucks.length, "entries.");
                renderTrucksTable(allTrucks);
                populateCaminhaoSelect(allTrucks);
                populateFilterCaminhaoSelect(allTrucks);
                if (isAuthReady && allAcertosData.length > 0) {
                    const filteredAcertos = getFilteredAcertos(allAcertosData);
                    renderAcertosTable(filteredAcertos);
                    calculateAcertosTotals(filteredAcertos);
                }
            }, (error) => {
                console.error("DEBUG: Error loading trucks: ", error.message, error);
                showModal("Erro ao carregar caminhões.");
            });
        }

        /**
         * Renderiza a tabela de caminhões cadastrados.
         * @param {Array<Object>} trucks - Uma lista de objetos de caminhão.
         */
        function renderTrucksTable(trucks) {
            trucksTableBody.innerHTML = '';
            if (trucks.length === 0) {
                trucksTableBody.innerHTML = `<tr><td colspan="3" class="py-3 px-6 text-center">Nenhum caminhão cadastrado.</td></tr>`;
                return;
            }
            trucks.forEach(truck => {
                const row = trucksTableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${truck.truckName}</td>
                    <td class="py-3 px-6 text-left">${truck.plate}</td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <button class="edit-truck-button text-blue-500 hover:text-blue-700 mr-2" data-id="${truck.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-truck-button text-red-500 hover:text-red-700" data-id="${truck.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });

            document.querySelectorAll('.edit-truck-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await editTruck(id);
                });
            });
            document.querySelectorAll('.delete-truck-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const confirmed = await showModal("Tem certeza que deseja excluir este caminhão?", 'confirm');
                    if (confirmed) {
                        await deleteTruck(id);
                    }
                });
            });
        }

        /**
         * Carrega os dados de um caminhão específico no formulário de cadastro para edição.
         * @param {string} id - O ID do documento do caminhão.
         */
        async function editTruck(id) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/trucks`, id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal("Caminhão não encontrado.");
                    return;
                }

                const truck = docSnap.data();
                truckNameInput.value = truck.truckName || '';
                truckPlateInput.value = truck.plate || '';
                
                if (saveTruckButton) {
                    saveTruckButton.textContent = 'Atualizar Caminhão';
                    const icon = saveTruckButton.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-truck-moving');
                        icon.classList.add('fa-sync-alt');
                    }
                    saveTruckButton.dataset.editId = id;
                }
                truckRegistrationForm.scrollIntoView({ behavior: 'smooth' });
                showModal("Caminhão carregado para edição.");
            } catch (error) {
                console.error("DEBUG: Error loading truck for editing:", error.message, error);
                showModal("Erro ao carregar caminhão para edição.");
            }
        }

        /**
         * Exclui um caminhão cadastrado.
         * @param {string} id - O ID do documento do caminhão.
         */
        async function deleteTruck(id) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/trucks`, id);
                await deleteDoc(docRef);
                showModal("Caminhão excluído com sucesso!");
            } catch (error) {
                console.error("DEBUG: Error deleting truck: ", error.message, error);
                showModal("Erro ao excluir caminhão.");
            }
        }

        /**
         * Popula o campo de seleção de caminhão no formulário de acerto com as placas dos caminhões cadastrados.
         * @param {Array<Object>} trucks - Uma lista de objetos de caminhão.
         */
        function populateCaminhaoSelect(trucks) {
            caminhaoSelect.innerHTML = '<option value="">Selecione um caminhão</option>';
            trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.plate;
                option.textContent = `${truck.plate} (${truck.truckName})`;
                caminhaoSelect.appendChild(option);
            });
        }

        /**
         * Popula o campo de seleção de filtro de caminhão na tabela de acertos.
         * @param {Array<Object>} trucks - Uma lista de objetos de caminhão.
         */
        function populateFilterCaminhaoSelect(trucks) {
            filterAcertoCaminhaoSelect.innerHTML = '<option value="">Todos os Caminhões</option>';
            trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck.plate;
                option.textContent = `${truck.plate} (${truck.truckName})`;
                filterAcertoCaminhaoSelect.appendChild(option);
            });
        }

        // --- Configuração de Listeners em Tempo Real ---
        /**
         * Configura todos os listeners em tempo real do Firestore. Chamado após a autenticação.
         */
        function setupRealtimeListeners() {
            console.log("DEBUG: Calling setupAcertosListener, setupCaixaListener, and setupTrucksListener.");
            setupAcertosListener();
            setupCaixaListener();
            setupTrucksListener();
        }

        // Configuração inicial para inputs de data para o dia atual
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayFormatted = `${yyyy}-${mm}-${dd}`;

        acertoDataInput.value = todayFormatted;
        caixaDataInput.value = todayFormatted;
        filterAcertoDataInicialInput.value = todayFormatted;
        filterAcertoDataFinalInput.value = todayFormatted;
        filterCaixaDataInicialInput.value = todayFormatted;
        filterCaixaDataFinalInput.value = todayFormatted;

        // Ensure default values are set on load for Caixa form
        clearCaixaForm();

    </script>
</body>
</html>
